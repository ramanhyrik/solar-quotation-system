<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ×‘×§×¨×” - ×”×¦×¢×•×ª ××—×™×¨ ×¡×•×œ××¨×™×•×ª</title>
    <link rel="stylesheet" href="/static/dashboard.css">
    <style>
        /* Calculator Styles */

        .model-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-radius: 50px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: #f0f0f0;
            padding: 4px;
        }

        .model-tab {
            flex: 1;
            padding: 14px 30px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
            color: #4a5568;
            border-radius: 50px;
        }

        .model-tab.active {
            background: #D9FF0D;
            color: #00358A;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .model-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
        }

        .calculator-input {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .calculator-input label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #4a5568;
        }

        .calculator-input input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 18px;
            transition: all 0.3s;
        }

        .calculator-input input:focus {
            outline: none;
            border-color: #00358A;
            box-shadow: 0 0 0 4px rgba(0, 53, 138, 0.1);
        }

        .calculator-input small {
            display: block;
            margin-top: 8px;
            color: #718096;
        }

        /* Direction Selector */
        .direction-selector {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .direction-selector label {
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
            color: #4a5568;
            text-align: center;
        }

        .direction-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .direction-btn {
            padding: 12px 8px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: #4a5568;
        }

        .direction-btn:hover {
            border-color: #00358A;
            background: #f7fafc;
        }

        .direction-btn.active {
            background: #00358A;
            color: white;
            border-color: #00358A;
        }

        .direction-btn .icon {
            font-size: 20px;
            display: block;
            margin-bottom: 5px;
        }

        /* Shading Toggle */
        .shading-toggle {
            background: white;
            border-radius: 16px;
            padding: 20px 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .shading-toggle label {
            font-weight: 600;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shading-toggle .sun-icon {
            font-size: 24px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 32px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: 0.3s;
            border-radius: 32px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #D9FF0D;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(28px);
        }

        .calculator-results {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .results-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .results-header h3 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .results-header p {
            color: #718096;
            font-size: 14px;
        }

        .income-forecast {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .income-box {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .income-box.highlight {
            background: linear-gradient(135deg, #00358A 0%, #004CAD 100%);
            color: white;
            border: none;
        }

        .income-box .value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .income-box .label {
            font-size: 14px;
            opacity: 0.9;
        }

        .income-box .currency {
            font-size: 16px;
            margin-right: 5px;
        }

        .system-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #D9FF0D 0%, #b8e600 100%);
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .system-info .icon {
            font-size: 30px;
        }

        .system-info .details {
            text-align: right;
        }

        .system-info .size {
            font-size: 28px;
            font-weight: 800;
            color: #00358A;
        }

        .system-info .label {
            font-size: 14px;
            color: #2d3748;
        }

        .environmental-impact {
            text-align: center;
            padding: 25px;
            background: #e8f5e9;
            border-radius: 12px;
            border: 2px solid #4caf50;
        }

        .environmental-impact .message {
            color: #1b5e20;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .trees-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .trees-icon {
            font-size: 40px;
        }

        .trees-count {
            font-size: 36px;
            font-weight: 800;
            color: #2e7d32;
        }

        .trees-label {
            font-size: 14px;
            color: #388e3c;
        }

        .calc-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .calc-actions button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-recalculate {
            background: white;
            color: #00358A;
            border: 2px solid #00358A !important;
        }

        .btn-recalculate:hover {
            background: #00358A;
            color: white;
        }

        .btn-contact {
            background: #D9FF0D;
            color: #00358A;
        }

        .btn-contact:hover {
            background: #c4e600;
        }

        /* Leasing specific styles */
        .leasing-terms {
            background: #fff3e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-right: 4px solid #ff9800;
        }

        .leasing-terms h4 {
            color: #e65100;
            margin-bottom: 10px;
        }

        .leasing-terms ul {
            margin: 0;
            padding-right: 20px;
            color: #795548;
        }

        .leasing-terms li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>â˜€ï¸ ×× ×¨×’×™×” ×¡×•×œ××¨×™×ª</h2>
        <nav>
            <a href="#" onclick="showSection('quote')" id="nav-quote" class="active">×”×¦×¢×” ×—×“×©×”</a>
            <a href="#" onclick="showSection('history')" id="nav-history">×”×™×¡×˜×•×¨×™×™×ª ×”×¦×¢×•×ª</a>
            {% if user.role == 'ADMIN' %}
            <a href="/admin">×œ×•×— × ×™×”×•×œ</a>
            <a href="/users">× ×™×”×•×œ ××©×ª××©×™×</a>
            {% endif %}
            <a href="#" onclick="showSection('calculator')" id="nav-calculator">××—×©×‘×•×Ÿ</a>
            <a href="/logout">×”×ª× ×ª×§</a>
        </nav>
        <div class="user-info">
            <p>{{ user.email }}</p>
            <p><small>{{ user.role }}</small></p>
        </div>
    </div>

    <div class="main-content">
        <!-- Calculator Section -->
        <div id="calculatorSection" style="display: none;">
            <h1>××—×©×‘×•×Ÿ ×× ×¨×’×™×” ×¡×•×œ××¨×™×ª</h1>

            <div class="model-tabs">
                <button class="model-tab" onclick="setModel('leasing')" id="tab-leasing">××•×“×œ ×œ×™×¡×™× ×’</button>
                <button class="model-tab active" onclick="setModel('purchase')" id="tab-purchase">××•×“×œ ×¨×›×™×©×”</button>
            </div>

            <div class="calculator-input">
                <label for="calcSystemSize">×’×•×“×œ ×”××¢×¨×›×ª (×§×™×œ×•×•××˜ ×©×™×)</label>
                <input type="number" id="calcSystemSize" step="0.1" placeholder="×”×–×Ÿ ×’×•×“×œ ××¢×¨×›×ª (×œ×“×•×’××”: 22.5)" value="22.5">
                <small>1 ×§×™×œ×•×•××˜ ×©×™× ×“×•×¨×© ×›-6 ×"×¨ ×©×˜×— ×’×’</small>
            </div>

            <div class="direction-selector">
                <label>×›×™×•×•×Ÿ ×”×’×’</label>
                <div class="direction-buttons">
                    <button type="button" class="direction-btn active" onclick="setDirection('south')" id="dir-south">
                        <span class="icon">â¬‡ï¸</span>
                        ×“×¨×•×
                    </button>
                    <button type="button" class="direction-btn" onclick="setDirection('southeast')" id="dir-southeast">
                        <span class="icon">â†˜ï¸</span>
                        ×“×¨×•×-××–×¨×—
                    </button>
                    <button type="button" class="direction-btn" onclick="setDirection('southwest')" id="dir-southwest">
                        <span class="icon">â†™ï¸</span>
                        ×“×¨×•×-××¢×¨×‘
                    </button>
                    <button type="button" class="direction-btn" onclick="setDirection('east_west')" id="dir-east_west">
                        <span class="icon">â†”ï¸</span>
                        ××–×¨×—-××¢×¨×‘
                    </button>
                </div>
            </div>

            <div class="shading-toggle">
                <label>
                    <span class="sun-icon">â˜€ï¸</span>
                    ×œ×œ× ×”×¦×œ×œ×”
                </label>
                <div class="toggle-switch">
                    <input type="checkbox" id="noShading" checked onchange="updateShading()">
                    <span class="toggle-slider"></span>
                </div>
            </div>

            <button onclick="calculateModel()" class="btn-calculate" style="width: 100%; margin-bottom: 20px;">×—×©×‘</button>

            <div id="calcResults" class="calculator-results" style="display: none;">
                <div class="results-header">
                    <h3>×¦×¤×™ ×”×›× ×¡×•×ª</h3>
                    <p id="modelDescription">××•×“×œ ×¨×›×™×©×” - ×‘×¢×œ×•×ª ××œ××” ×¢×œ ×”××¢×¨×›×ª</p>
                </div>

                <div class="income-forecast">
                    <div class="income-box highlight">
                        <div class="value"><span class="currency">â‚ª</span><span id="calcAnnualRevenue">0</span></div>
                        <div class="label">×‘×©× ×”</div>
                    </div>
                    <div class="income-box">
                        <div class="value"><span class="currency">â‚ª</span><span id="calcTotalRevenue">0</span></div>
                        <div class="label">×‘-25 ×©× ×™×</div>
                    </div>
                </div>

                <div id="purchaseDetails">
                    <div class="income-box" style="margin-bottom: 20px;">
                        <div class="value" style="font-size: 24px;"><span class="currency">â‚ª</span><span id="calcTotalPrice">0</span></div>
                        <div class="label">×¢×œ×•×ª ××¢×¨×›×ª</div>
                    </div>
                </div>

                <div id="leasingDetails" style="display: none;">
                    <div class="leasing-terms">
                        <h4>×ª× ××™ ×œ×™×¡×™× ×’</h4>
                        <ul>
                            <li>×œ×œ× ×¢×œ×•×ª ×”×ª×§× ×” ×¨××©×•× ×™×ª</li>
                            <li>×ª×©×œ×•× ×—×•×“×©×™ ×§×‘×•×¢: <strong id="monthlyPayment">â‚ª0</strong></li>
                            <li>×ª×—×–×•×§×” ×•××—×¨×™×•×ª ×›×œ×•×œ×™×</li>
                            <li>×—×•×–×” ×œ-25 ×©× ×™×</li>
                        </ul>
                    </div>
                </div>

                <div class="system-info">
                    <div class="icon">âš¡</div>
                    <div class="details">
                        <div class="size" id="calcSystemSizeDisplay">22.5kW</div>
                        <div class="label">×’×•×“×œ ××¢×¨×›×ª</div>
                    </div>
                </div>

                <div class="environmental-impact">
                    <div class="message">×›×“×•×¨ ×”××¨×¥ ××•××¨ ×ª×•×“×”! ×”×—×™×¡×›×•×Ÿ ×”×× ×¨×’×˜×™ ×©×•×•×” ×¢×¨×š ×œ:</div>
                    <div class="trees-display">
                        <div class="trees-icon">ğŸŒ³ğŸŒ³ğŸŒ³</div>
                        <div>
                            <div class="trees-count" id="calcTrees">0</div>
                            <div class="trees-label">×¢×¦×™× ×©× ×˜×¢×•</div>
                        </div>
                    </div>
                </div>

                <div class="calc-actions">
                    <button class="btn-recalculate" onclick="resetCalculator()">×—×©×‘ ×©×•×‘ â†»</button>
                    <button class="btn-contact" onclick="showSection('quote')">×“×‘×¨×• ××™×ª×™</button>
                </div>
            </div>
        </div>

        <!-- Quote Form Section -->
        <div id="quoteSection" class="quote-form-section">
            <h1>×™×¦×™×¨×ª ×”×¦×¢×” ×—×“×©×”</h1>

            <div class="quote-form">
                <h3>×¤×¨×˜×™ ×œ×§×•×—</h3>
                <div class="form-grid">
                    <input type="text" id="customerName" placeholder="×©× ×”×œ×§×•×— *" required>
                    <input type="tel" id="customerPhone" placeholder="×˜×œ×¤×•×Ÿ">
                    <input type="email" id="customerEmail" placeholder="××™××™×™×œ">
                    <input type="text" id="customerAddress" placeholder="×›×ª×•×‘×ª">
                </div>

                <h3>××¤×¨×˜ ××¢×¨×›×ª</h3>
                <div class="form-grid">
                    <input type="number" id="systemSize" placeholder="×’×•×“×œ ××¢×¨×›×ª (×§×•×˜×´×©) *" step="0.1" required>
                    <input type="number" id="roofArea" placeholder="×©×˜×— ×’×’ (××´×¨)" step="0.1">
                    <input type="text" id="panelType" placeholder="×¡×•×’ ×¤×× ×œ (×œ×“×•×’××”: Longi 550W)">
                    <input type="number" id="panelCount" placeholder="××¡×¤×¨ ×¤×× ×œ×™×">
                    <input type="text" id="inverterType" placeholder="×¡×•×’ ×××™×¨">
                    <select id="direction">
                        <option value="south">×“×¨×•×</option>
                        <option value="southwest">×“×¨×•×-××¢×¨×‘</option>
                        <option value="southeast">×“×¨×•×-××–×¨×—</option>
                        <option value="east_west">××–×¨×—-××¢×¨×‘</option>
                    </select>
                    <input type="number" id="tiltAngle" placeholder="×–×•×•×™×ª ×”×˜×™×” (Â°)" step="0.1">
                    <input type="number" id="warrantyYears" placeholder="××—×¨×™×•×ª (×©× ×™×)" value="25">
                </div>

                <button onclick="calculateQuote()" class="btn-calculate">×—×©×‘</button>

                <div id="calculations" class="calculations" style="display:none;">
                    <div class="calc-box">
                        <h4>××—×™×¨ ×›×•×œ×œ</h4>
                        <div class="calc-value" id="totalPrice">â‚ª0</div>
                    </div>
                    <div class="calc-box success">
                        <h4>×”×›× ×¡×” ×©× ×ª×™×ª</h4>
                        <div class="calc-value" id="annualRevenue">â‚ª0</div>
                    </div>
                    <div class="calc-box info">
                        <h4>×ª×§×•×¤×ª ×”×—×–×¨</h4>
                        <div class="calc-value" id="paybackPeriod">0 ×©× ×™×</div>
                    </div>
                </div>

                <div class="actions">
                    <button onclick="saveQuote()" class="btn-primary">×©××•×¨ ×”×¦×¢×”</button>
                    <button onclick="generatePDF()" class="btn-secondary">×”×¤×§ PDF</button>
                </div>
            </div>
        </div>

        <!-- Quote History Section -->
        <div id="historySection" style="display:none;">
            <h1>×”×™×¡×˜×•×¨×™×™×ª ×”×¦×¢×•×ª</h1>
            <table id="quotesTable">
                <thead>
                    <tr>
                        <th>××¡×³ ×”×¦×¢×”</th>
                        <th>×œ×§×•×—</th>
                        <th>×’×•×“×œ ××¢×¨×›×ª</th>
                        <th>××—×™×¨</th>
                        <th>×ª××¨×™×š</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script src="/static/dashboard.js"></script>
    <script>
        let currentModel = 'purchase';
        let currentDirection = 'south';
        let noShading = true;

        // Direction efficiency factors (south = 100%)
        const directionFactors = {
            'south': 1.0,
            'southeast': 0.95,
            'southwest': 0.95,
            'east_west': 0.85
        };

        function setDirection(direction) {
            currentDirection = direction;

            // Update button styles
            document.querySelectorAll('.direction-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('dir-' + direction).classList.add('active');

            // Recalculate if results are visible
            if (document.getElementById('calcResults').style.display !== 'none') {
                calculateModel();
            }
        }

        function updateShading() {
            noShading = document.getElementById('noShading').checked;

            // Recalculate if results are visible
            if (document.getElementById('calcResults').style.display !== 'none') {
                calculateModel();
            }
        }

        function showSection(section) {
            // Hide all sections
            document.getElementById('calculatorSection').style.display = 'none';
            document.getElementById('quoteSection').style.display = 'none';
            document.getElementById('historySection').style.display = 'none';

            // Remove active class from all nav items
            document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));

            // Show selected section
            if (section === 'calculator') {
                document.getElementById('calculatorSection').style.display = 'block';
                document.getElementById('nav-calculator').classList.add('active');
            } else if (section === 'quote') {
                document.getElementById('quoteSection').style.display = 'block';
                document.getElementById('nav-quote').classList.add('active');
            } else if (section === 'history') {
                document.getElementById('historySection').style.display = 'block';
                document.getElementById('nav-history').classList.add('active');
                loadQuoteHistory();
            }
        }

        function setModel(model) {
            currentModel = model;

            // Update tab styles
            document.getElementById('tab-leasing').classList.remove('active');
            document.getElementById('tab-purchase').classList.remove('active');

            if (model === 'leasing') {
                document.getElementById('tab-leasing').classList.add('active');
                document.getElementById('modelDescription').textContent = '××•×“×œ ×œ×™×¡×™× ×’ - ×œ×œ× ×¢×œ×•×ª ×”×ª×§× ×”';
                document.getElementById('purchaseDetails').style.display = 'none';
                document.getElementById('leasingDetails').style.display = 'block';
            } else {
                document.getElementById('tab-purchase').classList.add('active');
                document.getElementById('modelDescription').textContent = '××•×“×œ ×¨×›×™×©×” - ×‘×¢×œ×•×ª ××œ××” ×¢×œ ×”××¢×¨×›×ª';
                document.getElementById('purchaseDetails').style.display = 'block';
                document.getElementById('leasingDetails').style.display = 'none';
            }

            // Recalculate if results are visible
            if (document.getElementById('calcResults').style.display !== 'none') {
                calculateModel();
            }
        }

        async function calculateModel() {
            const systemSize = parseFloat(document.getElementById('calcSystemSize').value);

            if (!systemSize || systemSize <= 0) {
                alert('× × ×œ×”×–×™×Ÿ ×’×•×“×œ ××¢×¨×›×ª ×ª×§×™×Ÿ');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('system_size', systemSize);

                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                // Apply direction factor
                const directionFactor = directionFactors[currentDirection];

                // Apply shading factor (15% reduction if there's shading)
                const shadingFactor = noShading ? 1.0 : 0.85;

                // Combined efficiency factor
                const efficiencyFactor = directionFactor * shadingFactor;

                let annualRevenue = Math.round(data.annual_revenue * efficiencyFactor);
                let totalRevenue = annualRevenue * 25;

                // Adjust for leasing model
                if (currentModel === 'leasing') {
                    // Leasing takes about 30% of revenue as payment
                    const monthlyPayment = Math.round(annualRevenue * 0.3 / 12);
                    const yearlyPayment = monthlyPayment * 12;
                    annualRevenue = data.annual_revenue * efficiencyFactor - yearlyPayment;
                    annualRevenue = Math.round(annualRevenue);
                    totalRevenue = annualRevenue * 25;
                    document.getElementById('monthlyPayment').textContent = `â‚ª${monthlyPayment.toLocaleString()}`;
                }

                // Adjust trees for efficiency
                const adjustedTrees = Math.round(data.environmental_impact.trees * efficiencyFactor);

                // Update display
                document.getElementById('calcAnnualRevenue').textContent = annualRevenue.toLocaleString();
                document.getElementById('calcTotalRevenue').textContent = totalRevenue.toLocaleString();
                document.getElementById('calcTotalPrice').textContent = data.total_price.toLocaleString();
                document.getElementById('calcSystemSizeDisplay').textContent = `${systemSize}kW`;
                document.getElementById('calcTrees').textContent = adjustedTrees.toLocaleString();

                // Show results
                document.getElementById('calcResults').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                alert('×©×’×™××” ×‘×—×™×©×•×‘');
            }
        }

        function resetCalculator() {
            document.getElementById('calcResults').style.display = 'none';
            document.getElementById('calcSystemSize').value = '';
            document.getElementById('calcSystemSize').focus();
        }

        // Check URL parameter on page load
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const section = urlParams.get('section');
            if (section === 'calculator' || section === 'history') {
                showSection(section);
            }
        });
    </script>
</body>
</html>
