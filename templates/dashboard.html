<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>לוח בקרה - הצעות מחיר סולאריות</title>
    <link rel="stylesheet" href="/static/dashboard.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Calculator Styles */

        .model-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-radius: 50px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: #f0f0f0;
            padding: 4px;
        }

        .model-tab {
            flex: 1;
            padding: 14px 30px;
            border: none;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: transparent;
            color: #4a5568;
            border-radius: 50px;
        }

        .model-tab.active {
            background: #D9FF0D;
            color: #00358A;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .model-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
        }

        .calculator-input {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .calculator-input label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #4a5568;
        }

        .calculator-input input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 18px;
            transition: all 0.3s;
        }

        .calculator-input input:focus {
            outline: none;
            border-color: #00358A;
            box-shadow: 0 0 0 4px rgba(0, 53, 138, 0.1);
        }

        .calculator-input small {
            display: block;
            margin-top: 8px;
            color: #718096;
        }

        /* Direction Selector */
        .direction-selector {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        .direction-selector label {
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
            color: #4a5568;
            text-align: center;
        }

        .direction-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .direction-btn {
            padding: 12px 8px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: #4a5568;
        }

        .direction-btn:hover {
            border-color: #00358A;
            background: #f7fafc;
        }

        .direction-btn.active {
            background: #00358A;
            color: white;
            border-color: #00358A;
        }

        .direction-btn .icon {
            font-size: 20px;
            display: block;
            margin-bottom: 5px;
        }

        /* Shading Toggle */
        .shading-toggle {
            background: white;
            border-radius: 16px;
            padding: 20px 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .shading-toggle .shading-label {
            font-weight: 600;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .shading-toggle .sun-icon {
            font-size: 24px;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 32px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e2e8f0;
            transition: 0.3s;
            border-radius: 32px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #D9FF0D;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(28px);
        }

        .calculator-results {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .results-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .results-header h3 {
            color: #2d3748;
            font-size: 20px;
            margin-bottom: 5px;
        }

        .results-header p {
            color: #718096;
            font-size: 14px;
        }

        .income-forecast {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .income-box {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }

        .income-box.highlight {
            background: linear-gradient(135deg, #00358A 0%, #004CAD 100%);
            color: white;
            border: none;
        }

        .income-box .value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .income-box .label {
            font-size: 14px;
            opacity: 0.9;
        }

        .income-box .currency {
            font-size: 16px;
            margin-right: 5px;
        }

        .system-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #D9FF0D 0%, #b8e600 100%);
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .system-info .icon {
            font-size: 30px;
        }

        .system-info .details {
            text-align: right;
        }

        .system-info .size {
            font-size: 28px;
            font-weight: 800;
            color: #00358A;
        }

        .system-info .label {
            font-size: 14px;
            color: #2d3748;
        }

        .environmental-impact {
            text-align: center;
            padding: 25px;
            background: #e8f5e9;
            border-radius: 12px;
            border: 2px solid #4caf50;
        }

        .environmental-impact .message {
            color: #1b5e20;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .trees-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .trees-icon {
            font-size: 40px;
        }

        .trees-count {
            font-size: 36px;
            font-weight: 800;
            color: #2e7d32;
        }

        .trees-label {
            font-size: 14px;
            color: #388e3c;
        }

        .calc-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .calc-actions button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-recalculate {
            background: white;
            color: #00358A;
            border: 2px solid #00358A !important;
        }

        .btn-recalculate:hover {
            background: #00358A;
            color: white;
        }

        .btn-contact {
            background: #D9FF0D;
            color: #00358A;
        }

        .btn-contact:hover {
            background: #c4e600;
        }

        /* Leasing specific styles */
        .leasing-terms {
            background: #fff3e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-right: 4px solid #ff9800;
        }

        .leasing-terms h4 {
            color: #e65100;
            margin-bottom: 10px;
        }

        .leasing-terms ul {
            margin: 0;
            padding-right: 20px;
            color: #795548;
        }

        .leasing-terms li {
            margin-bottom: 5px;
        }

        /* Financial Comparison Styles */
        .comparison-container {
            max-width: 1400px;
            margin: 30px auto;
        }

        .metrics-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
            margin-top: 25px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            border-radius: 6px;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
        }

        .metric-row.highlight {
            background: #D9FF0D;
            border: 1px solid #D9FF0D;
            font-weight: 600;
        }

        .metric-row.success {
            background: #D9FF0D;
            border: 1px solid #D9FF0D;
            font-weight: 700;
            font-size: 18px;
        }

        .metric-label {
            color: #2d3748;
            font-size: 14px;
            text-align: right;
        }

        .metric-value {
            color: #00358A;
            font-size: 15px;
            font-weight: 600;
        }

        .analysis-section {
            background: #f0f9ff;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #00358A;
        }

        .analysis-section h3 {
            color: #00358A;
            margin-bottom: 15px;
            text-align: center;
            font-size: 16px;
        }

        .notes-section {
            background: #fffbeb;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-right: 4px solid #f59e0b;
        }

        .notes-section h4 {
            color: #92400e;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .notes-section p {
            color: #78350f;
            font-size: 12px;
            line-height: 1.6;
        }

        .data-table-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
            overflow-x: auto;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .comparison-table thead {
            background: #D9FF0D;
            position: sticky;
            top: 0;
        }

        .comparison-table thead th {
            padding: 10px 8px;
            text-align: center;
            font-weight: 700;
            color: #00358A;
            border: 1px solid #b8e600;
            font-size: 12px;
        }

        .comparison-table tbody tr {
            transition: background 0.2s;
        }

        .comparison-table tbody tr:hover {
            background: #f7fafc;
        }

        .comparison-table tbody td {
            padding: 6px 4px;
            text-align: center;
            border: 1px solid #e2e8f0;
            color: #2d3748;
            font-size: 12px;
        }

        .comparison-table tbody tr:first-child {
            background: #e2e8f0;
            font-weight: 700;
        }

        .comparison-table tbody tr.total-row {
            background: #00358A;
            color: white;
            font-weight: 700;
            font-size: 15px;
        }

        .comparison-table tbody tr.total-row td {
            border: 1px solid #002a6b;
            color: white;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            border-bottom: 2px solid #D9FF0D;
            padding-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2><i data-lucide="sun" style="width: 24px; height: 24px; vertical-align: middle; margin-left: 8px;"></i> אנרגיה סולארית</h2>
        <nav>
            <a href="#" onclick="showSection('quote')" id="nav-quote" class="active">הצעה חדשה</a>
            <a href="#" onclick="showSection('history')" id="nav-history">היסטוריית הצעות</a>
            {% if user.role == 'ADMIN' %}
            <a href="/admin">לוח ניהול</a>
            <a href="/users">ניהול משתמשים</a>
            {% endif %}
            <a href="#" onclick="showSection('calculator')" id="nav-calculator">מחשבון</a>
            <a href="#" onclick="showSection('comparison')" id="nav-comparison">השוואת תזרים מזומנים</a>
            <a href="/logout">התנתק</a>
        </nav>
        <div class="user-info">
            <p>{{ user.email }}</p>
            <p><small>{{ user.role }}</small></p>
        </div>
    </div>

    <div class="main-content">
        <!-- Calculator Section -->
        <div id="calculatorSection" style="display: none;">
            <h1>מחשבון אנרגיה סולארית</h1>

            <div class="model-tabs">
                <button class="model-tab" onclick="setModel('leasing')" id="tab-leasing">מודל ליסינג</button>
                <button class="model-tab active" onclick="setModel('purchase')" id="tab-purchase">מודל רכישה</button>
            </div>

            <div class="calculator-input">
                <label for="calcRoofArea">שטח הגג (מ"ר)</label>
<input type="number" id="calcRoofArea" step="1" placeholder="הזן שטח גג (לדוגמה: 135)" value="135">
                <small>כל 7 מ"ר גג = 1 קילוואט שיא</small>
            </div>

            <div class="direction-selector">
                <label>כיוון הגג</label>
                <div class="direction-buttons">
                    <button type="button" class="direction-btn active" onclick="setDirection('south')" id="dir-south">
                        <span class="icon"><i data-lucide="arrow-down"></i></span>
                        דרום
                    </button>
                    <button type="button" class="direction-btn" onclick="setDirection('southeast')" id="dir-southeast">
                        <span class="icon"><i data-lucide="arrow-down-right"></i></span>
                        דרום-מזרח
                    </button>
                    <button type="button" class="direction-btn" onclick="setDirection('southwest')" id="dir-southwest">
                        <span class="icon"><i data-lucide="arrow-down-left"></i></span>
                        דרום-מערב
                    </button>
                    <button type="button" class="direction-btn" onclick="setDirection('east_west')" id="dir-east_west">
                        <span class="icon"><i data-lucide="move-horizontal"></i></span>
                        מזרח-מערב
                    </button>
                </div>
            </div>

            <div class="shading-toggle">
                <span class="shading-label">
                    <span class="sun-icon"><i data-lucide="sun" style="width: 20px; height: 20px;"></i></span>
                    ללא הצללה
                </span>
                <label class="toggle-switch">
                    <input type="checkbox" id="noShading" checked onchange="updateShading()">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <button onclick="calculateModel()" class="btn-calculate" style="width: 100%; margin-bottom: 20px;">חשב</button>

            <div id="calcResults" class="calculator-results" style="display: none;">
                <div class="results-header">
                    <h3>צפי הכנסות</h3>
                    <p id="modelDescription">מודל רכישה - בעלות מלאה על המערכת</p>
                </div>

                <div id="purchaseDetails">
                    <div class="income-forecast" style="margin-bottom: 20px;">
                        <div class="income-box">
                            <div class="value" style="font-size: 24px;"><span class="currency">₪</span><span id="calcTotalPrice">0</span></div>
                            <div class="label">עלות מערכת</div>
                        </div>
                        <div class="income-box highlight">
                            <div class="value" style="font-size: 24px;"><span id="calcRoi">0</span><span style="font-size: 16px; margin-right: 3px;">%</span></div>
                            <div class="label">תשואה שנתית</div>
                        </div>
                    </div>
                </div>

                <div id="leasingDetails" style="display: none;">
                    <div class="leasing-terms">
                        <h4>תנאי ליסינג</h4>
                        <ul>
                            <li>ללא עלות התקנה ראשונית</li>
                            <li>תשלום חודשי קבוע: <strong id="monthlyPayment">₪0</strong></li>
                            <li>תחזוקה ואחריות כלולים</li>
                            <li dir="rtl">חוזה ל־25 שנים</li>
                        </ul>
                    </div>
                </div>

                <div class="system-info">
                    <div class="icon"><i data-lucide="zap" style="width: 28px; height: 28px;"></i></div>
                    <div class="details">
                        <div class="size" id="calcSystemSizeDisplay">22.5kW</div>
                        <div class="label">גודל מערכת</div>
                    </div>
                </div>

                <div class="environmental-impact">
                    <div class="message">כדור הארץ אומר תודה על 25 שנות חיסכון אנרגטי!</div>
                    <div class="trees-display">
                        <div class="trees-icon"><i data-lucide="trees" style="width: 40px; height: 40px; color: #2e7d32;"></i></div>
                        <div>
                            <div class="trees-count" id="calcTrees">0</div>
                            <div class="trees-label">עצים שנטעו</div>
                        </div>
                    </div>
                </div>

                <div class="calc-actions">
                    <button class="btn-recalculate" onclick="resetCalculator()">חשב שוב ↻</button>
                    <button class="btn-contact" onclick="showSection('quote')">דברו איתי</button>
                </div>
            </div>
        </div>

        <!-- Quote Form Section -->
        <div id="quoteSection" class="quote-form-section">
            <h1>יצירת הצעה חדשה</h1>

            <div class="quote-form">
                <h3>פרטי לקוח</h3>
                <div class="form-grid">
                    <input type="text" id="customerName" placeholder="שם הלקוח *" required>
                    <input type="tel" id="customerPhone" placeholder="טלפון">
                    <input type="email" id="customerEmail" placeholder="אימייל">
                    <input type="text" id="customerAddress" placeholder="כתובת">
                </div>

                <h3>מפרט מערכת</h3>
                <div class="form-grid">
                    <input type="number" id="systemSize" placeholder="גודל מערכת (קוט״ש) *" step="0.1" required oninput="autoCalculatePanelCount()">
                    <input type="number" id="roofArea" placeholder="שטח גג (מ״ר)" step="0.1">
                    <input type="text" id="panelType" placeholder="סוג פאנל (לדוגמה: Longi 550W)" oninput="autoCalculatePanelCount()">
                    <input type="number" id="panelCount" placeholder="מספר פאנלים" readonly>
                    <input type="text" id="inverterType" placeholder="סוג ממיר">
                    <select id="direction">
                        <option value="south">דרום</option>
                        <option value="southwest">דרום-מערב</option>
                        <option value="southeast">דרום-מזרח</option>
                        <option value="east_west">מזרח-מערב</option>
                    </select>
                    <input type="number" id="tiltAngle" placeholder="זווית הטיה (°)" step="0.1">
                    <input type="number" id="warrantyYears" placeholder="אחריות (שנים)" value="25">
                </div>

                <button onclick="calculateQuote()" class="btn-calculate">חשב</button>

                <div id="calculations" class="calculations" style="display:none;">
                    <div class="calc-box">
                        <h4>מחיר כולל</h4>
                        <div class="calc-value" id="totalPrice">₪0</div>
                    </div>
                    <div class="calc-box success">
                        <h4>הכנסה שנתית</h4>
                        <div class="calc-value" id="annualRevenue">₪0</div>
                    </div>
                    <div class="calc-box info">
                        <h4>תקופת החזר</h4>
                        <div class="calc-value" id="paybackPeriod">0 שנים</div>
                    </div>
                </div>

                <div class="actions">
                    <button onclick="saveQuote()" class="btn-primary">שמור הצעה</button>
                    <button onclick="generatePDF()" class="btn-secondary">הפק PDF</button>
                    <button onclick="viewFinancialAnalysis()" class="btn-secondary" style="background: #D9FF0D; color: #00358A;">הצג ניתוח פיננסי</button>
                </div>
            </div>
        </div>

        <!-- Quote History Section -->
        <div id="historySection" style="display:none;">
            <h1>היסטוריית הצעות</h1>
            <table id="quotesTable">
                <thead>
                    <tr>
                        <th>מס׳ הצעה</th>
                        <th>לקוח</th>
                        <th>גודל מערכת</th>
                        <th>מחיר</th>
                        <th>תאריך</th>
                        <th>פעולות</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Financial Comparison Section -->
        <div id="comparisonSection" style="display:none;">
            <h1>ניתוח פיננסי - תזרים מזומנים 25 שנה</h1>

            <div class="comparison-container">
                <!-- Cash flow table first -->
                <div class="data-table-panel">
                    <div class="section-title">תזרים מזומנים שנתי</div>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>שנה</th>
                                <th>השקעה</th>
                                <th>הכנסה</th>
                                <th>תפעול</th>
                                <th>רווח נקי</th>
                                <th>תזרים מצטבר</th>
                            </tr>
                        </thead>
                        <tbody id="comp-table-body">
                            <tr><td>0</td><td>0</td><td>-</td><td>-</td><td>-</td><td>0</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Financial metrics below -->
                <div class="metrics-panel">
                    <div class="section-title">מדדים פיננסיים</div>

                    <div class="metrics-grid">
                        <div class="metric-row highlight">
                            <div class="metric-label">עלות כוללת (כולל מע"מ)</div>
                            <div class="metric-value" id="comp-total-with-vat">0</div>
                        </div>
                        <div class="metric-row highlight">
                            <div class="metric-label">מחיר לקילו-וואט</div>
                            <div class="metric-value" id="comp-price-per-kwp">0</div>
                        </div>
                        <div class="metric-row success">
                            <div class="metric-label">תשואה שנתית (ROA)</div>
                            <div class="metric-value" id="comp-roa">0%</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-label">תקופת החזר (שנים)</div>
                            <div class="metric-value" id="comp-payback-years">0</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-label">תזרים מצטבר 25 שנה</div>
                            <div class="metric-value" id="comp-total-cashflow">0</div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-label">תשואה על הון (IRR)</div>
                            <div class="metric-value" id="comp-equity-irr">0%</div>
                        </div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border-right: 3px solid #00358A;">
                        <div style="font-size: 13px; font-weight: 600; color: #2d3748; margin-bottom: 8px;">הנחות יסוד</div>
                        <div style="font-size: 12px; color: #4a5568; line-height: 1.6;">
                            • ירידה שנתית בייצור: 0.4% | עלויות תפעול: 0.5% עלות המערכת, עלייה 2% בשנה<br>
                            • מחירי תעריפים עפ"י תקנות ייצור פרטי | אחריות: 25 שנה
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/dashboard.js"></script>
    <script>
        let currentModel = 'purchase';
        let currentDirection = 'south';
        let noShading = true;

        // Function to automatically calculate panel count based on system size and panel type
        function autoCalculatePanelCount() {
            const systemSize = parseFloat(document.getElementById('systemSize').value);
            const panelType = document.getElementById('panelType').value;

            if (!systemSize || !panelType) {
                return;
            }

            // Extract wattage from panel type (e.g., "Longi 550W" → 550 or "600W" → 600)
            const wattageMatch = panelType.match(/(\d+)\s*W/i);

            if (wattageMatch) {
                const panelWattage = parseInt(wattageMatch[1]);
                // Calculate panel count: system_size (kW) * 1000 / panel_wattage (W)
                const panelCount = Math.round((systemSize * 1000) / panelWattage);
                document.getElementById('panelCount').value = panelCount;
            }
        }

        // Direction efficiency factors (south = 100%)
        const directionFactors = {
            'south': 1.0,
            'southeast': 0.95,
            'southwest': 0.95,
            'east_west': 0.85
        };

        function setDirection(direction) {
            currentDirection = direction;

            // Update button styles
            document.querySelectorAll('.direction-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('dir-' + direction).classList.add('active');

            // Recalculate if results are visible
            if (document.getElementById('calcResults').style.display !== 'none') {
                calculateModel();
            }
        }

        function updateShading() {
            noShading = document.getElementById('noShading').checked;

            // Recalculate if results are visible
            if (document.getElementById('calcResults').style.display !== 'none') {
                calculateModel();
            }
        }

        function showSection(section) {
            // Hide all sections
            document.getElementById('calculatorSection').style.display = 'none';
            document.getElementById('quoteSection').style.display = 'none';
            document.getElementById('historySection').style.display = 'none';
            document.getElementById('comparisonSection').style.display = 'none';

            // Remove active class from all nav items
            document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));

            // Show selected section
            if (section === 'calculator') {
                document.getElementById('calculatorSection').style.display = 'block';
                document.getElementById('nav-calculator').classList.add('active');
            } else if (section === 'quote') {
                document.getElementById('quoteSection').style.display = 'block';
                document.getElementById('nav-quote').classList.add('active');
            } else if (section === 'history') {
                document.getElementById('historySection').style.display = 'block';
                document.getElementById('nav-history').classList.add('active');
                loadQuoteHistory();
            } else if (section === 'comparison') {
                document.getElementById('comparisonSection').style.display = 'block';
                document.getElementById('nav-comparison').classList.add('active');
            }
        }

        function setModel(model) {
            currentModel = model;

            // Update tab styles
            document.getElementById('tab-leasing').classList.remove('active');
            document.getElementById('tab-purchase').classList.remove('active');

            if (model === 'leasing') {
                document.getElementById('tab-leasing').classList.add('active');
                document.getElementById('modelDescription').textContent = 'מודל ליסינג - ללא עלות התקנה';
                document.getElementById('purchaseDetails').style.display = 'none';
                document.getElementById('leasingDetails').style.display = 'block';
            } else {
                document.getElementById('tab-purchase').classList.add('active');
                document.getElementById('modelDescription').textContent = 'מודל רכישה - בעלות מלאה על המערכת';
                document.getElementById('purchaseDetails').style.display = 'block';
                document.getElementById('leasingDetails').style.display = 'none';
            }

            // Recalculate if results are visible
            if (document.getElementById('calcResults').style.display !== 'none') {
                calculateModel();
            }
        }

        async function calculateModel() {
            const roofArea = parseFloat(document.getElementById('calcRoofArea').value);

            if (!roofArea || roofArea <= 0) {
                alert('נא להזין שטח גג תקין');
                return;
            }

            // Calculate system size from roof area (7 sqm per kWp)
            const systemSize = roofArea / 7;

            try {
                const formData = new FormData();
                formData.append('system_size', systemSize);

                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                // Apply direction factor
                const directionFactor = directionFactors[currentDirection];

                // Apply shading factor (15% reduction if there's shading)
                const shadingFactor = noShading ? 1.0 : 0.85;

                // Combined efficiency factor
                const efficiencyFactor = directionFactor * shadingFactor;

                let annualRevenue = Math.round(data.annual_revenue * efficiencyFactor);
                let totalRevenue = annualRevenue * 25;

                // Adjust for leasing model
                if (currentModel === 'leasing') {
                    // Leasing takes about 30% of revenue as payment
                    const monthlyPayment = Math.round(annualRevenue * 0.3 / 12);
                    const yearlyPayment = monthlyPayment * 12;
                    annualRevenue = data.annual_revenue * efficiencyFactor - yearlyPayment;
                    annualRevenue = Math.round(annualRevenue);
                    totalRevenue = annualRevenue * 25;
                    document.getElementById('monthlyPayment').textContent = `₪${monthlyPayment.toLocaleString()}`;
                }

                // Adjust trees for efficiency
                const adjustedTrees = Math.round(data.environmental_impact.trees * efficiencyFactor);

                // Calculate ROI percentage (Annual Return / System Cost * 100)
                const roiPercentage = ((annualRevenue / data.total_price) * 100).toFixed(1);

                // Update display
                document.getElementById('calcAnnualRevenue').textContent = annualRevenue.toLocaleString();
                document.getElementById('calcTotalRevenue').textContent = totalRevenue.toLocaleString();
                document.getElementById('calcTotalPrice').textContent = data.total_price.toLocaleString();
                document.getElementById('calcRoi').textContent = roiPercentage;
                document.getElementById('calcSystemSizeDisplay').textContent = `${systemSize.toFixed(1)}kW`;
                document.getElementById('calcTrees').textContent = adjustedTrees.toLocaleString();

                // Show results
                document.getElementById('calcResults').style.display = 'block';

            } catch (error) {
                console.error('Error:', error);
                alert('שגיאה בחישוב');
            }
        }

        function resetCalculator() {
            document.getElementById('calcResults').style.display = 'none';
            document.getElementById('calcRoofArea').value = '';
            document.getElementById('calcRoofArea').focus();
        }

        // Financial Analysis Functions
        function viewFinancialAnalysis() {
            const systemSize = parseFloat(document.getElementById('systemSize').value);
            const totalPrice = parseFloat(document.getElementById('totalPrice').textContent.replace(/[^\d.-]/g, ''));

            if (!systemSize || !totalPrice) {
                alert('נא לחשב את ההצעה תחילה');
                return;
            }

            // Calculate and display financial analysis
            calculateFinancialComparison(systemSize, totalPrice);

            // Switch to comparison section
            showSection('comparison');
        }

        async function calculateFinancialComparison(systemSize, totalPrice) {
            // Basic calculations
            const pricePerKwp = (totalPrice / 1.18) / systemSize; // Price per kWp before VAT
            const systemPriceBeforeVAT = totalPrice / 1.18;
            const operationalCost = 0; // As shown in image
            const totalWithVAT = totalPrice;

            // Calculate annual revenue using existing API
            const formData = new FormData();
            formData.append('system_size', systemSize);

            const response = await fetch('/api/calculate', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            const annualRevenue = Math.round(data.annual_revenue);
            const totalRevenue25Years = annualRevenue * 25;

            // Financial metrics
            const roa = ((annualRevenue / totalPrice) * 100).toFixed(1);
            const paybackYears = (totalPrice / annualRevenue).toFixed(2);
            const totalCashflow = totalRevenue25Years - totalPrice;
            const irr = roa; // Simplified IRR calculation

            // Update metrics panel
            document.getElementById('comp-total-with-vat').textContent = `₪${(totalWithVAT / 1000).toFixed(1)}K`;
            document.getElementById('comp-price-per-kwp').textContent = `₪${(pricePerKwp / 1000).toFixed(2)}K`;
            document.getElementById('comp-roa').textContent = roa + '%';
            document.getElementById('comp-payback-years').textContent = paybackYears;
            document.getElementById('comp-total-cashflow').textContent = `₪${(totalCashflow / 1000).toFixed(1)}K`;
            document.getElementById('comp-equity-irr').textContent = irr + '%';

            // Generate 25-year table
            generateCashflowTable(systemSize, totalPrice, annualRevenue);
        }

        function generateCashflowTable(systemSize, totalPrice, annualRevenue) {
            const tbody = document.getElementById('comp-table-body');
            tbody.innerHTML = '';

            // Year 0 - Initial investment
            const row0 = document.createElement('tr');
            row0.innerHTML = `<td>0</td><td>${(-totalPrice).toLocaleString()}</td><td>-</td><td>-</td><td>-</td><td>${(-totalPrice).toLocaleString()}</td>`;
            tbody.appendChild(row0);

            // Annual degradation rate (~0.4% per year for production)
            const degradationRate = 0.004;
            // Operating cost: starts at 0.5% of system cost, increases 2% yearly
            const baseOperatingCost = totalPrice * 0.005;

            let cumulativeCashflow = -totalPrice;
            let totalRevenue = 0;
            let totalOperatingCost = 0;
            let totalNetProfit = 0;

            // Years 1-25
            for (let year = 1; year <= 25; year++) {
                const yearlyDegradation = 1 - (degradationRate * (year - 1));
                const yearRevenue = Math.round(annualRevenue * yearlyDegradation);
                const yearOperatingCost = Math.round(baseOperatingCost * Math.pow(1.02, year - 1));
                const yearNetProfit = yearRevenue - yearOperatingCost;

                totalRevenue += yearRevenue;
                totalOperatingCost += yearOperatingCost;
                totalNetProfit += yearNetProfit;
                cumulativeCashflow = totalNetProfit - totalPrice;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${year}</td>
                    <td>-</td>
                    <td>${yearRevenue.toLocaleString()}</td>
                    <td>${yearOperatingCost.toLocaleString()}</td>
                    <td>${yearNetProfit.toLocaleString()}</td>
                    <td>${cumulativeCashflow.toLocaleString()}</td>
                `;
                tbody.appendChild(row);
            }

            // Total row
            const totalRow = document.createElement('tr');
            totalRow.className = 'total-row';
            totalRow.innerHTML = `
                <td>סה"כ</td>
                <td>${(-totalPrice).toLocaleString()}</td>
                <td>${totalRevenue.toLocaleString()}</td>
                <td>${totalOperatingCost.toLocaleString()}</td>
                <td>${totalNetProfit.toLocaleString()}</td>
                <td>${cumulativeCashflow.toLocaleString()}</td>
            `;
            tbody.appendChild(totalRow);
        }

        // Check URL parameter on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Lucide icons
            lucide.createIcons();

            const urlParams = new URLSearchParams(window.location.search);
            const section = urlParams.get('section');
            if (section === 'calculator' || section === 'history' || section === 'comparison') {
                showSection(section);
            }
        });
    </script>
</body>
</html>
