<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול משתמשים - הצעות מחיר סולאריות</title>
    <link rel="stylesheet" href="/static/dashboard.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body.embedded {
            background: #f9fafb;
        }
        body.embedded .sidebar {
            display: none;
        }
        body.embedded .main-content {
            margin-right: 0;
            width: 100%;
            padding: 20px;
            max-width: 1200px;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2><i data-lucide="sun" style="width: 24px; height: 24px; vertical-align: middle; margin-left: 8px;"></i> אנרגיה סולארית</h2>
        <nav>
            <a href="/dashboard">הצעה חדשה</a>
            <a href="/dashboard?section=history">היסטוריית הצעות</a>
            <a href="/admin">לוח ניהול</a>
            <a href="/users" class="active">ניהול משתמשים</a>
            <a href="/submissions">פניות לקוחות</a>
            <a href="/roof-designer">מעצב גגות</a>
            <a href="/dashboard?section=calculator">מחשבון</a>
            <a href="/dashboard?section=comparison">השוואת תזרים מזומנים</a>
            <a href="/logout">התנתק</a>
        </nav>
        <div class="user-info">
            <p>{{ user.email }}</p>
            <p><small>מנהל</small></p>
        </div>
    </div>

    <div class="main-content">
        <h1>ניהול משתמשים</h1>

        <div class="quote-form">
            <h3>יצירת משתמש חדש</h3>
            <form id="createUserForm">
                <div class="form-grid">
                    <div>
                        <label>שם מלא</label>
                        <input type="text" id="userName" placeholder="ישראל ישראלי" required>
                    </div>
                    <div>
                        <label>אימייל</label>
                        <input type="email" id="userEmail" placeholder="israel@example.com" required>
                    </div>
                    <div>
                        <label>סיסמה</label>
                        <input type="password" id="userPassword" placeholder="מינימום 8 תווים" minlength="8" required>
                    </div>
                    <div>
                        <label>תפקיד</label>
                        <input type="text" id="userRole" required placeholder="לדוגמה: מנהל, נציג מכירות, מעצב" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>
                <button type="submit" class="btn-calculate">צור משתמש</button>
            </form>
        </div>

        <div class="quote-form" style="margin-top: 20px;">
            <h3>משתמשים קיימים</h3>
            <div class="quote-history">
                <table>
                    <thead>
                        <tr>
                            <th>שם</th>
                            <th>אימייל</th>
                            <th>תפקיד</th>
                            <th>נוצר</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #999;">טוען משתמשים...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- חלון עריכת משתמש -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; color: #ffffff;">עריכת משתמש</h3>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #ffffff;">שם מלא</label>
                    <input type="text" id="editUserName" required style="width: 100%; padding: 10px; border: 2px solid rgba(58, 228, 120, 0.3); border-radius: 8px; font-size: 14px; background: rgba(20, 24, 31, 0.6); color: #ffffff;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #ffffff;">אימייל</label>
                    <input type="email" id="editUserEmail" required style="width: 100%; padding: 10px; border: 2px solid rgba(58, 228, 120, 0.3); border-radius: 8px; font-size: 14px; background: rgba(20, 24, 31, 0.6); color: #ffffff;">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #ffffff;">סיסמה חדשה (השאר ריק לשמירת הנוכחית)</label>
                    <input type="password" id="editUserPassword" placeholder="אופציונלי" style="width: 100%; padding: 10px; border: 2px solid rgba(58, 228, 120, 0.3); border-radius: 8px; font-size: 14px; background: rgba(20, 24, 31, 0.6); color: #ffffff;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #ffffff;">תפקיד</label>
                    <input type="text" id="editUserRole" required placeholder="לדוגמה: מנהל, נציג מכירות, מעצב" style="width: 100%; padding: 10px; border: 2px solid rgba(58, 228, 120, 0.3); border-radius: 8px; font-size: 14px; background: rgba(20, 24, 31, 0.6); color: #ffffff;">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn-calculate" style="flex: 1;">שמור שינויים</button>
                    <button type="button" onclick="closeEditModal()" class="btn-calculate" style="flex: 1; background: rgba(26, 29, 34, 0.8); color: #3AE478; border: 2px solid #3AE478;">ביטול</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let users = [];

        // Embedded mode: hide sidebar when loaded with ?embedded=1
        const params = new URLSearchParams(window.location.search);
        if (params.get('embedded') === '1') {
            document.body.classList.add('embedded');
        }

        // טעינת משתמשים
        async function loadUsers() {
            try {
                const response = await fetch('/api/users', {
                    credentials: 'same-origin'
                });
                if (response.ok) {
                    users = await response.json();
                    displayUsers();
                } else {
                    console.error('שגיאה בטעינת משתמשים');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // הצגת משתמשים בטבלה
        function displayUsers() {
            const tbody = document.getElementById('usersTableBody');

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">לא נמצאו משתמשים</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name || 'לא זמין'}</td>
                    <td>${user.email}</td>
                    <td><span style="padding: 4px 8px; background: ${user.role === 'ADMIN' ? '#3B82F6' : '#3AE478'}; color: ${user.role === 'ADMIN' ? 'white' : '#14181F'}; border-radius: 4px; font-size: 12px; font-weight: 600;">${user.role}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString('he-IL')}</td>
                    <td>
                        <button onclick="editUser(${user.id})" style="padding: 6px 12px; background: #3AE478; color: #14181F; border: none; border-radius: 4px; cursor: pointer; margin-left: 5px; font-weight: 600;">ערוך</button>
                        <button onclick="deleteUser(${user.id}, '${user.email}')" style="padding: 6px 12px; background: #F97316; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">מחק</button>
                    </td>
                </tr>
            `).join('');
        }

        // יצירת משתמש
        document.getElementById('createUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData();
            formData.append('name', document.getElementById('userName').value);
            formData.append('email', document.getElementById('userEmail').value);
            formData.append('password', document.getElementById('userPassword').value);
            formData.append('role', document.getElementById('userRole').value);

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    alert('המשתמש נוצר בהצלחה!');
                    document.getElementById('createUserForm').reset();
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert('שגיאה ביצירת משתמש: ' + (error.detail || 'שגיאה לא ידועה'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('שגיאה ביצירת משתמש');
            }
        });

        // עריכת משתמש
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editUserName').value = user.name || '';
            document.getElementById('editUserEmail').value = user.email;
            document.getElementById('editUserPassword').value = '';
            document.getElementById('editUserRole').value = user.role;

            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // עדכון משתמש
        document.getElementById('editUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const userId = document.getElementById('editUserId').value;
            const formData = new FormData();
            formData.append('name', document.getElementById('editUserName').value);
            formData.append('email', document.getElementById('editUserEmail').value);
            formData.append('role', document.getElementById('editUserRole').value);

            const password = document.getElementById('editUserPassword').value;
            if (password) {
                formData.append('password', password);
            }

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    body: formData,
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    alert('המשתמש עודכן בהצלחה!');
                    closeEditModal();
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert('שגיאה בעדכון משתמש: ' + (error.detail || 'שגיאה לא ידועה'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('שגיאה בעדכון משתמש');
            }
        });

        // מחיקת משתמש
        async function deleteUser(userId, userEmail) {
            if (!confirm(`האם אתה בטוח שברצונך למחוק את המשתמש "${userEmail}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    alert('המשתמש נמחק בהצלחה!');
                    loadUsers();
                } else {
                    const error = await response.json();
                    alert('שגיאה במחיקת משתמש: ' + (error.detail || 'שגיאה לא ידועה'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('שגיאה במחיקת משתמש');
            }
        }

        loadUsers();
        lucide.createIcons();
    </script>
</body>
</html>
