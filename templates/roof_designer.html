<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Roof Designer - Solar Panel Layout Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --primary-blue: #2563eb;
            --primary-dark: #1e40af;
            --success-green: #10B981;
            --text-dark: #1F2937;
            --text-medium: #6B7280;
            --border-color: #E5E7EB;
            --bg-gray: #F9FAFB;
            --sidebar-width: 350px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            background: var(--bg-gray);
            color: var(--text-dark);
            line-height: 1.6;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 16px 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header-right {
            font-size: 13px;
            text-align: right;
        }

        .header-right a {
            color: #93C5FD;
            text-decoration: none;
            margin-left: 16px;
        }

        .header-right a:hover {
            color: white;
        }

        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        /* Left Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Sidebar Sections */
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-medium);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title i,
        .section-title svg {
            width: 16px;
            height: 16px;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-gray);
        }

        .upload-zone:hover {
            background: #EFF6FF;
            border-color: var(--primary-blue);
        }

        .upload-zone svg {
            width: 32px;
            height: 32px;
            margin: 0 auto 8px;
            color: var(--text-medium);
        }

        .upload-zone h3 {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 4px;
        }

        .upload-zone p {
            font-size: 11px;
            color: var(--text-medium);
        }

        .image-preview {
            margin-top: 12px;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .image-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .image-info {
            background: var(--bg-gray);
            padding: 8px 12px;
            font-size: 11px;
            color: var(--text-medium);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Tool Buttons */
        .tool-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .tool-btn {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-dark);
        }

        .tool-btn:hover {
            background: var(--bg-gray);
            border-color: var(--primary-blue);
        }

        .tool-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .tool-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tool-btn.primary {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .tool-btn.primary:hover {
            background: var(--primary-dark);
        }

        .tool-btn.success {
            background: var(--success-green);
            color: white;
            border-color: var(--success-green);
        }

        .tool-btn.success:hover {
            background: #059669;
        }

        .tool-btn.danger {
            border-color: #EF4444;
            color: #EF4444;
        }

        .tool-btn.danger:hover {
            background: #FEE2E2;
        }

        .tool-btn i,
        .tool-btn svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .tool-grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 12px;
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.15s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            font-size: 11px;
            color: var(--text-medium);
        }

        /* Collapsible Section */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .collapsible-header i {
            transition: transform 0.2s;
        }

        .collapsible-header.collapsed i {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            margin-top: 12px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            margin-top: 0;
        }

        /* Results Panel */
        .results-panel {
            background: linear-gradient(135deg, var(--success-green) 0%, #059669 100%);
            color: white;
            padding: 16px;
            border-radius: 8px;
        }

        .results-panel h3 {
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .result-item {
            text-align: center;
        }

        .result-label {
            font-size: 11px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .result-value {
            font-size: 20px;
            font-weight: 700;
        }

        /* Info Box */
        .info-box {
            background: #EFF6FF;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            border-left: 3px solid var(--primary-blue);
            font-size: 12px;
        }

        .info-box strong {
            display: block;
            margin-bottom: 4px;
            color: var(--text-dark);
        }

        .info-box p {
            margin: 0;
            color: var(--text-medium);
            font-size: 11px;
        }

        /* Canvas Area */
        .canvas-area {
            flex: 1;
            background: #F3F4F6;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .canvas-container {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .canvas-placeholder {
            text-align: center;
            color: var(--text-medium);
            padding: 60px 40px;
        }

        .canvas-placeholder svg {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            opacity: 0.3;
        }

        .canvas-placeholder h2 {
            font-size: 20px;
            margin-bottom: 8px;
            color: var(--text-dark);
        }

        .canvas-placeholder p {
            font-size: 14px;
        }

        /* Zoom Controls Overlay */
        .zoom-overlay {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 4px;
            z-index: 100;
        }

        .zoom-overlay button {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .zoom-overlay button:hover {
            background: var(--bg-gray);
            border-color: var(--primary-blue);
        }

        .zoom-overlay button i {
            width: 18px;
            height: 18px;
        }

        .zoom-level {
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            padding: 4px 0;
            color: var(--text-dark);
        }

        .zoom-tip {
            font-size: 10px;
            color: var(--text-medium);
            text-align: center;
            margin-top: 4px;
            padding: 6px 8px;
            background: var(--bg-gray);
            border-radius: 4px;
        }

        /* Icon Toolbars */
        .icon-toolbar {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border: 1px solid var(--border-color);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            position: relative;
        }

        .icon-btn:hover {
            background: var(--bg-gray);
            border-color: var(--primary-blue);
        }

        .icon-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .icon-btn.primary {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .icon-btn.primary:hover {
            background: var(--primary-dark);
        }

        .icon-btn.danger {
            border-color: #EF4444;
            color: #EF4444;
        }

        .icon-btn.danger:hover {
            background: #FEE2E2;
        }

        .icon-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .icon-btn i,
        .icon-btn svg {
            width: 20px;
            height: 20px;
        }

        .icon-btn[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -32px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
        }

        .toolbar-divider {
            width: 100%;
            height: 1px;
            background: var(--border-color);
            margin: 12px 0;
        }

        /* Modal System */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            animation: slideUp 0.3s ease-out;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-header h3 {
            flex: 1;
            margin: 0;
            font-size: 18px;
            color: var(--text-dark);
        }

        .modal-header i {
            width: 24px;
            height: 24px;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: #f3f4f6;
        }

        .modal-close i {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .modal-body {
            padding: 24px;
            color: var(--text-medium);
            line-height: 1.6;
        }

        .modal-body p {
            margin: 0;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-footer .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .modal-footer .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .modal-footer .btn-primary:hover {
            background: var(--primary-dark);
        }

        .modal-footer .btn-secondary {
            background: #6B7280;
            color: white;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            text-align: center;
            color: white;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-spinner p {
            font-size: 16px;
            font-weight: 500;
        }

        /* Keyboard shortcuts table */
        .shortcuts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .shortcuts-table th {
            background: var(--bg-gray);
            padding: 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
        }

        .shortcuts-table td {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .shortcuts-table tr:last-child td {
            border-bottom: none;
        }

        kbd {
            background: linear-gradient(to bottom, #f9f9f9, #e9e9e9);
            border: 1px solid #aaa;
            border-radius: 4px;
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset;
            color: #333;
            display: inline-block;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: 600;
            line-height: 1;
            padding: 4px 8px;
            white-space: nowrap;
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }

        /* Customer info section */
        .customer-info {
            background: var(--bg-gray);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .customer-info-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        /* Instruction badge */
        .instruction-badge {
            background: #FEF3C7;
            color: #92400E;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 12px;
            border-left: 3px solid #F59E0B;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div>
            <h1>Manual Roof Designer</h1>
        </div>
        <div class="header-right">
            <span>Welcome, {{ user.name }}!</span>
            <a href="/dashboard">Dashboard</a>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <!-- Upload Section -->
            <div class="sidebar-section">
                <div class="section-title">
                    <i data-lucide="upload"></i>
                    <span>Upload Roof Image</span>
                </div>

                <div class="upload-zone" id="uploadZone">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <h3>Click or drag image</h3>
                    <p>JPG, PNG (Max 10MB)</p>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                </div>

                <div id="imagePreviewContainer" class="hidden">
                    <div class="image-preview">
                        <img id="uploadedImageThumb" src="" alt="Uploaded roof">
                        <div class="image-info">
                            <span id="imageFileName">roof.jpg</span>
                            <button class="tool-btn" onclick="clearImage()" style="width: auto; padding: 4px 8px; font-size: 11px;">
                                <i data-lucide="x"></i>
                                Clear
                            </button>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Tools Section -->
            <div class="sidebar-section" id="toolsSection">
                <div class="section-title">
                    <i data-lucide="wrench"></i>
                    <span>Tools</span>
                </div>

                <div id="drawingInstruction" class="instruction-badge" style="font-size: 11px;">
                    Upload an image to start
                </div>

                <!-- Drawing Tools -->
                <div class="icon-toolbar">
                    <button class="icon-btn primary" id="autoDetectBtn" onclick="autoDetectRoof()" disabled
                            data-tooltip="AI Auto-Detect">
                        <i data-lucide="sparkles"></i>
                    </button>

                    <button class="icon-btn active" id="drawRoofBtn" onclick="startDrawingRoof()" disabled
                            data-tooltip="Draw Roof">
                        <i data-lucide="home"></i>
                    </button>

                    <button class="icon-btn" id="drawExclusionBtn" onclick="startDrawingExclusion()" disabled
                            data-tooltip="Add Exclusion">
                        <i data-lucide="octagon-x"></i>
                    </button>

                    <button class="icon-btn" id="closePolygonBtn" onclick="closePolygon()" disabled
                            data-tooltip="Close Polygon">
                        <i data-lucide="check-circle"></i>
                    </button>

                    <button class="icon-btn" id="editModeBtn" onclick="toggleEditMode()" disabled
                            data-tooltip="Edit Points">
                        <i data-lucide="edit-3"></i>
                    </button>
                </div>

                <div class="toolbar-divider"></div>

                <!-- Edit Tools -->
                <div class="icon-toolbar">
                    <button class="icon-btn" id="undoBtn" onclick="undo()" disabled
                            data-tooltip="Undo">
                        <i data-lucide="undo"></i>
                    </button>

                    <button class="icon-btn" id="redoBtn" onclick="redo()" disabled
                            data-tooltip="Redo">
                        <i data-lucide="redo"></i>
                    </button>

                    <button class="icon-btn danger" id="deleteBtn" onclick="deleteSelected()" disabled
                            data-tooltip="Delete Selected">
                        <i data-lucide="trash-2"></i>
                    </button>

                    <button class="icon-btn danger" id="clearAllBtn" onclick="clearAll()" disabled
                            data-tooltip="Clear All">
                        <i data-lucide="rotate-ccw"></i>
                    </button>
                </div>

                <div class="toolbar-divider"></div>

                <!-- Settings & Config -->
                <div class="icon-toolbar">
                    <button class="icon-btn" id="panelConfigBtn" onclick="openPanelConfigModal()" disabled
                            data-tooltip="Panel Settings">
                        <i data-lucide="settings"></i>
                    </button>

                    <button class="icon-btn" id="calculateBtn" onclick="calculatePanelLayout()" disabled
                            data-tooltip="Calculate Layout">
                        <i data-lucide="calculator"></i>
                    </button>

                    <button class="icon-btn" id="shortcutsBtn" onclick="showKeyboardShortcuts()" disabled
                            data-tooltip="Keyboard Shortcuts">
                        <i data-lucide="keyboard"></i>
                    </button>
                </div>

                <div style="margin-top: 16px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label style="font-size: 11px;">Scale (px/m)</label>
                        <input type="number" id="pixelsPerMeter" value="100" min="10" max="1000" step="10" disabled
                               style="font-size: 12px; padding: 6px 8px;">
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="sidebar-section" id="resultsSection" style="display: none;">
                <div class="results-panel">
                    <h3>Layout Results</h3>
                    <div class="result-grid">
                        <div class="result-item">
                            <div class="result-label">Panels</div>
                            <div class="result-value" id="resultPanels">0</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Power</div>
                            <div class="result-value" id="resultPower">0 kW</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Coverage</div>
                            <div class="result-value" id="resultCoverage">0%</div>
                        </div>
                        <div class="result-item">
                            <div class="result-label">Area</div>
                            <div class="result-value" id="resultArea">0 mÂ²</div>
                        </div>
                    </div>
                </div>

                <button class="tool-btn success" onclick="saveDesign()" id="saveBtn" style="margin-top: 12px;" disabled>
                    <i data-lucide="save"></i>
                    <span>Save Design</span>
                </button>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-area">
            <div id="canvasPlaceholder" class="canvas-placeholder">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                <h2>Upload a Roof Image to Begin</h2>
                <p>Upload a clear, top-down photo of the roof to start designing</p>
            </div>

            <div class="canvas-container hidden" id="canvasContainer">
                <canvas id="roofCanvas" width="1200" height="800"></canvas>
            </div>

            <!-- Zoom Controls Overlay -->
            <div class="zoom-overlay hidden" id="zoomControls">
                <button onclick="zoomIn()">
                    <i data-lucide="zoom-in"></i>
                </button>
                <div class="zoom-level" id="zoomLevel">100%</div>
                <button onclick="zoomOut()">
                    <i data-lucide="zoom-out"></i>
                </button>
                <button onclick="resetZoom()">
                    <i data-lucide="maximize"></i>
                </button>
                <div class="zoom-tip">
                    Hold <kbd>Space</kbd> + drag to pan
                </div>
            </div>
        </div>
    </div>

    <!-- Modal System -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <i data-lucide="alert-circle" id="modalIcon"></i>
                <h3 id="modalTitle">Alert</h3>
                <button class="modal-close" onclick="closeModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="modalMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal(false)" id="modalCancelBtn" style="display: none;">Cancel</button>
                <button class="btn btn-primary" onclick="closeModal()" id="modalOkBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Panel Configuration Modal -->
    <div id="panelConfigModal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <i data-lucide="settings"></i>
                <h3>Panel Configuration</h3>
                <button class="modal-close" onclick="closePanelConfigModal()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="info-box" style="margin-bottom: 16px;">
                    <p>Configure solar panel specifications and layout preferences</p>
                </div>

                <div class="form-group">
                    <label>Panel Width (m)</label>
                    <input type="number" id="panelWidth" value="1.7" min="0.8" max="2.5" step="0.1">
                    <small>Range: 0.8m - 2.5m</small>
                </div>

                <div class="form-group">
                    <label>Panel Height (m)</label>
                    <input type="number" id="panelHeight" value="1.0" min="0.8" max="2.0" step="0.1">
                    <small>Range: 0.8m - 2.0m</small>
                </div>

                <div class="form-group">
                    <label>Panel Power (W)</label>
                    <input type="number" id="panelPower" value="400" min="100" max="1000" step="50">
                </div>

                <div class="form-group">
                    <label>Orientation</label>
                    <select id="orientation">
                        <option value="auto" selected>Auto (Optimal Mix)</option>
                        <option value="landscape">Landscape Only</option>
                        <option value="portrait">Portrait Only</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 0;">
                    <label>Spacing (cm)</label>
                    <input type="number" id="spacing" value="5" min="0" max="20" step="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePanelConfigModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePanelConfig()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p id="loadingMessage">Processing...</p>
        </div>
    </div>

    <script>
        // Global variables
        let canvas = null;
        let designId = null;
        let uploadedImage = null;
        let roofPolygonPoints = [];
        let exclusionZones = [];
        let currentExclusionPoints = [];
        let roofPolygonObject = null;
        let drawingMode = null;
        let panels = [];

        // Image scaling
        let imageScaleFactor = 1;
        let originalImageWidth = 0;
        let originalImageHeight = 0;

        // Command history for undo/redo
        const commandHistory = {
            undoStack: [],
            redoStack: [],
            maxSize: 50
        };

        // Canvas zoom and pan
        let canvasZoom = 1;
        let isPanning = false;
        let panStartPoint = null;
        let viewportTransform = [1, 0, 0, 1, 0, 0];
        const MIN_ZOOM = 0.5;
        const MAX_ZOOM = 5;

        // Edit mode
        let editMode = false;
        let editingPolygon = null;
        let vertexCircles = [];

        // AI detection
        let detectedCandidates = [];
        let candidatePolygons = [];
        let showingCandidates = false;

        class Command {
            constructor(execute, undo, description) {
                this.execute = execute;
                this.undo = undo;
                this.description = description;
            }
        }

        function executeCommand(command) {
            command.execute();
            commandHistory.undoStack.push(command);
            commandHistory.redoStack = [];

            if (commandHistory.undoStack.length > commandHistory.maxSize) {
                commandHistory.undoStack.shift();
            }

            updateUndoRedoButtons();
        }

        function undo() {
            if (commandHistory.undoStack.length === 0) return;

            const command = commandHistory.undoStack.pop();
            command.undo();
            commandHistory.redoStack.push(command);
            updateUndoRedoButtons();
        }

        function redo() {
            if (commandHistory.redoStack.length === 0) return;

            const command = commandHistory.redoStack.pop();
            command.execute();
            commandHistory.undoStack.push(command);
            updateUndoRedoButtons();
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            if (undoBtn) undoBtn.disabled = commandHistory.undoStack.length === 0;
            if (redoBtn) redoBtn.disabled = commandHistory.redoStack.length === 0;
        }

        // Zoom functions
        function zoomIn() {
            if (!canvas) return;
            const newZoom = Math.min(canvasZoom * 1.2, MAX_ZOOM);
            setZoom(newZoom);
        }

        function zoomOut() {
            if (!canvas) return;
            const newZoom = Math.max(canvasZoom / 1.2, MIN_ZOOM);
            setZoom(newZoom);
        }

        function resetZoom() {
            if (!canvas) return;
            canvasZoom = 1;
            canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
            canvas.renderAll();
            updateZoomDisplay();
        }

        function setZoom(zoom, centerPoint = null) {
            if (!canvas) return;

            canvasZoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom));

            if (!centerPoint) {
                centerPoint = new fabric.Point(canvas.width / 2, canvas.height / 2);
            }

            canvas.zoomToPoint(centerPoint, canvasZoom);
            canvas.renderAll();
            updateZoomDisplay();
        }

        function updateZoomDisplay() {
            const zoomPercentage = Math.round(canvasZoom * 100);
            document.getElementById('zoomLevel').textContent = `${zoomPercentage}%`;
        }

        // Edit mode functions
        function toggleEditMode() {
            if (!canvas) return;

            editMode = !editMode;
            const editBtn = document.getElementById('editModeBtn');

            if (editMode) {
                editBtn.classList.add('active');
                document.getElementById('drawingInstruction').textContent =
                    'Edit mode: Drag yellow circles';

                drawingMode = null;
                document.getElementById('drawRoofBtn').classList.remove('active');
                document.getElementById('drawExclusionBtn').classList.remove('active');
            } else {
                editBtn.classList.remove('active');
                exitEditMode();
                updateDrawingInstruction();
            }
        }

        function exitEditMode() {
            vertexCircles.forEach(circle => canvas.remove(circle));
            vertexCircles = [];
            editingPolygon = null;
            if (canvas) canvas.renderAll();
        }

        function enableEditMode(polygon) {
            exitEditMode();
            editingPolygon = polygon;

            const points = polygon.points;
            points.forEach((point, index) => {
                const circle = new fabric.Circle({
                    left: polygon.left + point.x * polygon.scaleX,
                    top: polygon.top + point.y * polygon.scaleY,
                    radius: 6,
                    fill: '#FCD34D',
                    stroke: '#92400E',
                    strokeWidth: 2,
                    originX: 'center',
                    originY: 'center',
                    hasControls: false,
                    hasBorders: false,
                    selectable: true,
                    pointIndex: index,
                    parentPolygon: polygon
                });

                circle.on('moving', function() {
                    const poly = this.parentPolygon;
                    const idx = this.pointIndex;
                    const newX = (this.left - poly.left) / poly.scaleX;
                    const newY = (this.top - poly.top) / poly.scaleY;
                    poly.points[idx].x = newX;
                    poly.points[idx].y = newY;
                    canvas.renderAll();
                });

                vertexCircles.push(circle);
                canvas.add(circle);
            });

            canvas.renderAll();
        }

        // Drawing functions
        function startDrawingRoof() {
            if (!canvas) return;

            drawingMode = 'roof';
            exitEditMode();
            document.getElementById('drawRoofBtn').classList.add('active');
            document.getElementById('drawExclusionBtn').classList.remove('active');
            document.getElementById('editModeBtn').classList.remove('active');
            updateDrawingInstruction();
        }

        function startDrawingExclusion() {
            if (!canvas) return;

            drawingMode = 'exclusion';
            currentExclusionPoints = [];
            exitEditMode();
            document.getElementById('drawExclusionBtn').classList.add('active');
            document.getElementById('drawRoofBtn').classList.remove('active');
            document.getElementById('editModeBtn').classList.remove('active');
            updateDrawingInstruction();
        }

        function updateDrawingInstruction() {
            const instruction = document.getElementById('drawingInstruction');
            if (drawingMode === 'roof') {
                instruction.textContent = 'Click to draw roof boundary';
            } else if (drawingMode === 'exclusion') {
                instruction.textContent = 'Click to draw exclusion zone';
            } else {
                instruction.textContent = 'Select a tool to begin';
            }
        }

        function closePolygon() {
            if (!canvas) return;

            if (drawingMode === 'roof' && roofPolygonPoints.length >= 3) {
                if (roofPolygonObject) {
                    canvas.remove(roofPolygonObject);
                }

                roofPolygonObject = new fabric.Polygon(roofPolygonPoints, {
                    fill: 'rgba(59, 130, 246, 0.3)',
                    stroke: '#2563eb',
                    strokeWidth: 3,
                    selectable: true,
                    objectCaching: false,
                    polygonType: 'roof'
                });

                canvas.add(roofPolygonObject);
                canvas.renderAll();

                drawingMode = null;
                document.getElementById('drawRoofBtn').classList.remove('active');
                updateDrawingInstruction();
                enablePanelConfig();

                showModal('Success', 'Roof boundary created! You can now configure panel layout.', 'info-circle');
            } else if (drawingMode === 'exclusion' && currentExclusionPoints.length >= 3) {
                const exclusionPoly = new fabric.Polygon(currentExclusionPoints, {
                    fill: 'rgba(239, 68, 68, 0.3)',
                    stroke: '#ef4444',
                    strokeWidth: 2,
                    selectable: true,
                    objectCaching: false,
                    polygonType: 'exclusion'
                });

                exclusionZones.push({
                    points: [...currentExclusionPoints],
                    polygon: exclusionPoly
                });

                canvas.add(exclusionPoly);
                canvas.renderAll();

                currentExclusionPoints = [];
                drawingMode = null;
                document.getElementById('drawExclusionBtn').classList.remove('active');
                updateDrawingInstruction();
            } else {
                showModal('Error', 'You need at least 3 points to close a polygon.', 'alert-circle');
            }
        }

        function deleteSelected() {
            if (!canvas) return;

            const activeObject = canvas.getActiveObject();
            if (!activeObject) {
                showModal('Error', 'Please select a polygon first.', 'alert-circle');
                return;
            }

            if (activeObject.polygonType === 'roof') {
                const oldPolygon = roofPolygonObject;
                const oldPoints = [...roofPolygonPoints];

                const command = new Command(
                    () => {
                        canvas.remove(roofPolygonObject);
                        roofPolygonObject = null;
                        roofPolygonPoints = [];
                        canvas.renderAll();
                        disablePanelConfig();
                    },
                    () => {
                        roofPolygonPoints = oldPoints;
                        roofPolygonObject = oldPolygon;
                        canvas.add(roofPolygonObject);
                        canvas.renderAll();
                        enablePanelConfig();
                    },
                    'Delete roof polygon'
                );
                executeCommand(command);
            } else if (activeObject.polygonType === 'exclusion') {
                const zoneIndex = exclusionZones.findIndex(z => z.polygon === activeObject);
                if (zoneIndex !== -1) {
                    const oldZone = exclusionZones[zoneIndex];

                    const command = new Command(
                        () => {
                            canvas.remove(activeObject);
                            exclusionZones.splice(zoneIndex, 1);
                            canvas.renderAll();
                        },
                        () => {
                            exclusionZones.splice(zoneIndex, 0, oldZone);
                            canvas.add(oldZone.polygon);
                            canvas.renderAll();
                        },
                        'Delete exclusion zone'
                    );
                    executeCommand(command);
                }
            }
        }

        function clearAll() {
            if (!canvas) return;

            showConfirmModal(
                'Clear All',
                'Are you sure you want to clear all drawings? This cannot be undone.',
                () => {
                    canvas.getObjects().forEach(obj => {
                        if (obj.polygonType === 'roof' || obj.polygonType === 'exclusion') {
                            canvas.remove(obj);
                        }
                    });

                    roofPolygonPoints = [];
                    roofPolygonObject = null;
                    exclusionZones = [];
                    currentExclusionPoints = [];
                    exitEditMode();
                    canvas.renderAll();

                    commandHistory.undoStack = [];
                    commandHistory.redoStack = [];
                    updateUndoRedoButtons();
                    disablePanelConfig();
                }
            );
        }

        function clearImage() {
            showConfirmModal(
                'Clear Image',
                'Are you sure? This will remove the image and all drawings.',
                () => {
                    if (canvas) {
                        canvas.dispose();
                        canvas = null;
                    }

                    uploadedImage = null;
                    roofPolygonPoints = [];
                    roofPolygonObject = null;
                    exclusionZones = [];

                    document.getElementById('imagePreviewContainer').classList.add('hidden');
                    document.getElementById('canvasContainer').classList.add('hidden');
                    document.getElementById('canvasPlaceholder').classList.remove('hidden');
                    document.getElementById('zoomControls').classList.add('hidden');

                    disableDrawingTools();
                    disablePanelConfig();

                    commandHistory.undoStack = [];
                    commandHistory.redoStack = [];
                    updateUndoRedoButtons();
                }
            );
        }

        // Panel configuration
        function enablePanelConfig() {
            document.getElementById('panelConfigBtn').disabled = false;
            document.getElementById('calculateBtn').disabled = false;
        }

        function disablePanelConfig() {
            document.getElementById('panelConfigBtn').disabled = true;
            document.getElementById('calculateBtn').disabled = true;
            document.getElementById('resultsSection').style.display = 'none';
        }

        function enableDrawingTools() {
            document.getElementById('autoDetectBtn').disabled = false;
            document.getElementById('drawRoofBtn').disabled = false;
            document.getElementById('drawExclusionBtn').disabled = false;
            document.getElementById('closePolygonBtn').disabled = false;
            document.getElementById('editModeBtn').disabled = false;
            document.getElementById('deleteBtn').disabled = false;
            document.getElementById('clearAllBtn').disabled = false;
            document.getElementById('pixelsPerMeter').disabled = false;
            document.getElementById('shortcutsBtn').disabled = false;
        }

        function disableDrawingTools() {
            document.getElementById('autoDetectBtn').disabled = true;
            document.getElementById('drawRoofBtn').disabled = true;
            document.getElementById('drawExclusionBtn').disabled = true;
            document.getElementById('closePolygonBtn').disabled = true;
            document.getElementById('editModeBtn').disabled = true;
            document.getElementById('deleteBtn').disabled = true;
            document.getElementById('clearAllBtn').disabled = true;
            document.getElementById('pixelsPerMeter').disabled = true;
            document.getElementById('shortcutsBtn').disabled = true;
        }

        // Calculate panel layout
        async function calculatePanelLayout() {
            if (!roofPolygonObject) {
                showModal('Error', 'Please draw a roof boundary first.', 'alert-circle');
                return;
            }

            showLoading('Calculating optimal panel layout...');

            try {
                const panelWidth = parseFloat(document.getElementById('panelWidth').value);
                const panelHeight = parseFloat(document.getElementById('panelHeight').value);
                const panelPower = parseFloat(document.getElementById('panelPower').value);
                const orientation = document.getElementById('orientation').value;
                const spacing = parseFloat(document.getElementById('spacing').value) / 100;
                const pixelsPerMeter = parseFloat(document.getElementById('pixelsPerMeter').value);

                const roofPointsOriginal = roofPolygonPoints.map(p => ({
                    x: p.x / imageScaleFactor,
                    y: p.y / imageScaleFactor
                }));

                const exclusionsOriginal = exclusionZones.map(zone =>
                    zone.points.map(p => ({
                        x: p.x / imageScaleFactor,
                        y: p.y / imageScaleFactor
                    }))
                );

                const formData = new FormData();
                formData.append('design_id', designId);
                formData.append('roof_polygon', JSON.stringify(roofPointsOriginal));
                formData.append('obstacles', JSON.stringify(exclusionsOriginal.map(zone => ({ points: zone }))));
                formData.append('panel_width_m', panelWidth);
                formData.append('panel_height_m', panelHeight);
                formData.append('panel_power_w', panelPower);
                formData.append('spacing_m', spacing);
                formData.append('pixels_per_meter', pixelsPerMeter);
                formData.append('orientation', orientation);

                const response = await fetch('/api/roof-designer/calculate-layout', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    panels = result.panels;
                    displayPanels(panels);
                    displayResults(result);
                    document.getElementById('resultsSection').style.display = 'block';
                    document.getElementById('saveBtn').disabled = false;
                    showModal('Success', `Successfully placed ${result.total_panels || result.num_panels} panels!`, 'check-circle');
                } else {
                    showModal('Error', result.error || 'Failed to calculate layout.', 'alert-circle');
                }
            } catch (error) {
                hideLoading();
                showModal('Error', 'Failed to calculate panel layout: ' + error.message, 'alert-circle');
            }
        }

        function displayPanels(panels) {
            canvas.getObjects().forEach(obj => {
                if (obj.objectType === 'panel') {
                    canvas.remove(obj);
                }
            });

            panels.forEach((panel, index) => {
                const scaledPanel = panel.map(p => ({
                    x: p.x * imageScaleFactor,
                    y: p.y * imageScaleFactor
                }));

                const panelRect = new fabric.Polygon(scaledPanel, {
                    fill: 'rgba(16, 185, 129, 0.4)',
                    stroke: '#059669',
                    strokeWidth: 1,
                    selectable: false,
                    objectCaching: false,
                    objectType: 'panel',
                    panelIndex: index
                });

                canvas.add(panelRect);
            });

            canvas.renderAll();
        }

        function displayResults(result) {
            document.getElementById('resultPanels').textContent = result.total_panels || result.num_panels || 0;
            document.getElementById('resultPower').textContent = ((result.total_power_kw || result.total_power / 1000) || 0).toFixed(2) + ' kW';
            document.getElementById('resultCoverage').textContent = (result.coverage_percent || result.coverage_percentage || 0).toFixed(1) + '%';
            document.getElementById('resultArea').textContent = (result.roof_area_m2 || result.roof_area || 0).toFixed(1) + ' mÂ²';
        }

        // Save design
        async function saveDesign() {
            if (!roofPolygonObject || panels.length === 0) {
                showModal('Error', 'Please calculate panel layout first.', 'alert-circle');
                return;
            }

            showLoading('Saving your design...');

            try {
                const canvasData = canvas.toDataURL('image/png');

                const formData = new FormData();
                formData.append('design_id', designId);
                formData.append('visualization', canvasData);

                const response = await fetch('/api/roof-designer/save-visualization', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    showModal('Success', 'Design saved successfully!', 'check-circle', () => {
                        window.location.href = '/dashboard';
                    });
                } else {
                    showModal('Error', result.error || 'Failed to save design.', 'alert-circle');
                }
            } catch (error) {
                hideLoading();
                showModal('Error', 'Failed to save design: ' + error.message, 'alert-circle');
            }
        }

        // AI Auto-detect
        async function autoDetectRoof() {
            if (!uploadedImage || !designId) {
                showModal('Error', 'Please upload an image first.', 'alert-circle');
                return;
            }

            showLoading('AI is analyzing your roof...');

            try {
                // Step 1: Start detection job
                const formData = new FormData();
                formData.append('design_id', designId);

                const startResponse = await fetch('/api/roof-designer/auto-detect', {
                    method: 'POST',
                    body: formData
                });

                const startResult = await startResponse.json();

                if (!startResult.success || !startResult.job_id) {
                    hideLoading();
                    showModal('Error', startResult.error || 'Failed to start detection', 'alert-circle');
                    return;
                }

                const jobId = startResult.job_id;
                console.log('[AI-DETECT] Job started:', jobId);

                // Step 2: Poll for results
                let attempts = 0;
                const maxAttempts = 120; // 120 seconds max (2 minutes)
                const pollInterval = 1000; // 1 second

                const pollJob = async () => {
                    attempts++;

                    if (attempts > maxAttempts) {
                        hideLoading();
                        showModal('Timeout', 'Detection took too long. Please try with a smaller image or draw manually.', 'alert-circle');
                        return;
                    }

                    // Update loading message
                    if (attempts % 3 === 0) {
                        showLoading(`AI analyzing... ${attempts}s`);
                    }

                    try {
                        const statusResponse = await fetch(`/api/roof-designer/auto-detect-status/${jobId}`);
                        const statusResult = await statusResponse.json();

                        if (statusResult.status === 'completed') {
                            hideLoading();

                            const result = statusResult.result;
                            if (result && result.candidates && result.candidates.length > 0) {
                                detectedCandidates = result.candidates;
                                displayCandidates(detectedCandidates);
                                showModal('AI Detection Complete', `Found ${result.candidates.length} potential roof area(s). Click on a highlighted area to select it.`, 'sparkles');
                            } else {
                                showModal('No Roof Detected', 'AI could not detect a roof. Please draw manually.', 'alert-circle');
                            }
                        } else if (statusResult.status === 'failed') {
                            hideLoading();
                            showModal('Detection Failed', statusResult.error || 'Detection failed', 'alert-circle');
                        } else {
                            // Still pending or running - poll again
                            setTimeout(pollJob, pollInterval);
                        }
                    } catch (pollError) {
                        console.error('[AI-DETECT] Poll error:', pollError);
                        setTimeout(pollJob, pollInterval);
                    }
                };

                // Start polling
                setTimeout(pollJob, pollInterval);

            } catch (error) {
                hideLoading();
                showModal('Error', 'AI detection failed: ' + error.message, 'alert-circle');
            }
        }

        function displayCandidates(candidates) {
            candidatePolygons.forEach(poly => canvas.remove(poly));
            candidatePolygons = [];

            candidates.forEach((candidate, index) => {
                const scaledPoints = (candidate.points || candidate.polygon).map(p => ({
                    x: p.x * imageScaleFactor,
                    y: p.y * imageScaleFactor
                }));

                const poly = new fabric.Polygon(scaledPoints, {
                    fill: 'rgba(251, 191, 36, 0.3)',
                    stroke: '#F59E0B',
                    strokeWidth: 3,
                    selectable: true,
                    objectCaching: false,
                    polygonType: 'candidate',
                    candidateIndex: index,
                    confidence: candidate.confidence
                });

                poly.on('selected', function() {
                    selectCandidate(this.candidateIndex);
                });

                candidatePolygons.push(poly);
                canvas.add(poly);
            });

            showingCandidates = true;
            canvas.renderAll();
        }

        function selectCandidate(index) {
            const candidate = detectedCandidates[index];

            if (roofPolygonObject) {
                canvas.remove(roofPolygonObject);
            }

            roofPolygonPoints = (candidate.points || candidate.polygon).map(p => ({
                x: p.x * imageScaleFactor,
                y: p.y * imageScaleFactor
            }));

            roofPolygonObject = new fabric.Polygon(roofPolygonPoints, {
                fill: 'rgba(59, 130, 246, 0.3)',
                stroke: '#2563eb',
                strokeWidth: 3,
                selectable: true,
                objectCaching: false,
                polygonType: 'roof'
            });

            candidatePolygons.forEach(poly => canvas.remove(poly));
            candidatePolygons = [];
            showingCandidates = false;

            canvas.add(roofPolygonObject);
            canvas.renderAll();

            enablePanelConfig();
            showModal('Roof Selected', 'AI-detected roof boundary applied! You can now edit it or configure panels.', 'check-circle');
        }

        // Keyboard shortcuts
        function showKeyboardShortcuts() {
            const shortcuts = `
                <table class="shortcuts-table">
                    <tr>
                        <th>Action</th>
                        <th>Shortcut</th>
                    </tr>
                    <tr>
                        <td>Undo</td>
                        <td><kbd>Ctrl</kbd> + <kbd>Z</kbd></td>
                    </tr>
                    <tr>
                        <td>Redo</td>
                        <td><kbd>Ctrl</kbd> + <kbd>Y</kbd></td>
                    </tr>
                    <tr>
                        <td>Delete Selected</td>
                        <td><kbd>Delete</kbd></td>
                    </tr>
                    <tr>
                        <td>Pan Canvas</td>
                        <td>Hold <kbd>Space</kbd> + Drag</td>
                    </tr>
                    <tr>
                        <td>Zoom In/Out</td>
                        <td><kbd>Ctrl</kbd> + Scroll</td>
                    </tr>
                    <tr>
                        <td>Reset Zoom</td>
                        <td><kbd>Ctrl</kbd> + <kbd>0</kbd></td>
                    </tr>
                </table>
            `;

            showModal('Keyboard Shortcuts', shortcuts, 'keyboard');
        }

        // Modal functions
        function showModal(title, message, icon = 'alert-circle', callback = null) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('modalIcon').setAttribute('data-lucide', icon);
            document.getElementById('modalCancelBtn').style.display = 'none';

            const modal = document.getElementById('modalOverlay');
            modal.classList.add('active');

            lucide.createIcons();

            if (callback) {
                const okBtn = document.getElementById('modalOkBtn');
                okBtn.onclick = () => {
                    closeModal();
                    callback();
                };
            } else {
                document.getElementById('modalOkBtn').onclick = closeModal;
            }
        }

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            document.getElementById('modalIcon').setAttribute('data-lucide', 'alert-triangle');
            document.getElementById('modalCancelBtn').style.display = 'inline-block';

            const modal = document.getElementById('modalOverlay');
            modal.classList.add('active');

            lucide.createIcons();

            document.getElementById('modalOkBtn').onclick = () => {
                closeModal();
                onConfirm();
            };
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Panel Configuration Modal
        function openPanelConfigModal() {
            document.getElementById('panelConfigModal').classList.add('active');
            lucide.createIcons();
        }

        function closePanelConfigModal() {
            document.getElementById('panelConfigModal').classList.remove('active');
        }

        function savePanelConfig() {
            closePanelConfigModal();
            showModal('Settings Saved', 'Panel configuration has been updated. Click "Calculate Layout" to apply.', 'check-circle');
        }

        // Upload and canvas initialization
        document.getElementById('uploadZone').addEventListener('click', () => {
            document.getElementById('imageInput').click();
        });

        document.getElementById('uploadZone').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });

        document.getElementById('uploadZone').addEventListener('drop', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                await handleImageUpload(file);
            }
        });

        document.getElementById('imageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                await handleImageUpload(file);
            }
        });

        async function handleImageUpload(file) {
            if (file.size > 10 * 1024 * 1024) {
                showModal('Error', 'File size exceeds 10MB limit.', 'alert-circle');
                return;
            }

            showLoading('Uploading image...');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('/api/roof-designer/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    designId = result.design_id;
                    await loadImageOnCanvas(result.image_url);

                    document.getElementById('imageFileName').textContent = file.name;
                    document.getElementById('uploadedImageThumb').src = result.image_url;
                    document.getElementById('imagePreviewContainer').classList.remove('hidden');
                } else {
                    showModal('Error', result.error || 'Upload failed.', 'alert-circle');
                }
            } catch (error) {
                hideLoading();
                showModal('Error', 'Failed to upload image: ' + error.message, 'alert-circle');
            }
        }

        async function loadImageOnCanvas(imageUrl) {
            return new Promise((resolve, reject) => {
                fabric.Image.fromURL(imageUrl, (img) => {
                    if (!img || !img.width || !img.height) {
                        reject(new Error('Failed to load image'));
                        return;
                    }

                    originalImageWidth = img.width;
                    originalImageHeight = img.height;

                    const canvasWidth = 1200;
                    const canvasHeight = 800;

                    const scale = Math.min(
                        canvasWidth / img.width,
                        canvasHeight / img.height
                    );

                    imageScaleFactor = scale;

                    const canvasElement = document.getElementById('roofCanvas');
                    canvasElement.width = canvasWidth;
                    canvasElement.height = canvasHeight;

                    if (canvas) {
                        canvas.dispose();
                    }

                    canvas = new fabric.Canvas('roofCanvas', {
                        selection: false,
                        backgroundColor: '#F3F4F6'
                    });

                    img.scale(scale);
                    img.set({
                        left: (canvasWidth - img.width * scale) / 2,
                        top: (canvasHeight - img.height * scale) / 2,
                        selectable: false,
                        evented: false
                    });

                    canvas.add(img);
                    canvas.sendToBack(img);
                    uploadedImage = img;

                    setupCanvasEvents();

                    document.getElementById('canvasPlaceholder').classList.add('hidden');
                    document.getElementById('canvasContainer').classList.remove('hidden');
                    document.getElementById('zoomControls').classList.remove('hidden');

                    enableDrawingTools();
                    startDrawingRoof();

                    resolve();
                }, { crossOrigin: 'anonymous' });
            });
        }

        function setupCanvasEvents() {
            canvas.on('mouse:down', function(opt) {
                const evt = opt.e;

                if (evt.spaceKey || isPanning) {
                    isPanning = true;
                    canvas.selection = false;
                    panStartPoint = { x: evt.clientX, y: evt.clientY };
                    return;
                }

                if (editMode) {
                    const target = canvas.findTarget(opt.e);
                    if (target && (target.polygonType === 'roof' || target.polygonType === 'exclusion')) {
                        enableEditMode(target);
                    }
                    return;
                }

                if (showingCandidates) {
                    const target = canvas.findTarget(opt.e);
                    if (target && target.polygonType === 'candidate') {
                        selectCandidate(target.candidateIndex);
                    }
                    return;
                }

                if (!drawingMode) return;

                const pointer = canvas.getPointer(opt.e);

                if (drawingMode === 'roof') {
                    roofPolygonPoints.push({ x: pointer.x, y: pointer.y });
                    drawPolygonPreview(roofPolygonPoints, 'rgba(59, 130, 246, 0.2)', '#2563eb');
                } else if (drawingMode === 'exclusion') {
                    currentExclusionPoints.push({ x: pointer.x, y: pointer.y });
                    drawPolygonPreview(currentExclusionPoints, 'rgba(239, 68, 68, 0.2)', '#ef4444');
                }
            });

            canvas.on('mouse:move', function(opt) {
                if (isPanning && panStartPoint) {
                    const evt = opt.e;
                    const vpt = canvas.viewportTransform;
                    vpt[4] += evt.clientX - panStartPoint.x;
                    vpt[5] += evt.clientY - panStartPoint.y;
                    canvas.requestRenderAll();
                    panStartPoint = { x: evt.clientX, y: evt.clientY };
                }
            });

            canvas.on('mouse:up', function() {
                isPanning = false;
                canvas.selection = true;
            });

            canvas.on('mouse:wheel', function(opt) {
                if (opt.e.ctrlKey) {
                    opt.e.preventDefault();
                    opt.e.stopPropagation();

                    const delta = opt.e.deltaY;
                    let zoom = canvas.getZoom();
                    zoom *= 0.999 ** delta;

                    zoom = Math.max(MIN_ZOOM, Math.min(MAX_ZOOM, zoom));

                    canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, zoom);
                    canvasZoom = zoom;
                    updateZoomDisplay();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === ' ') {
                    e.preventDefault();
                    e.spaceKey = true;
                } else if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    undo();
                } else if (e.ctrlKey && e.key === 'y') {
                    e.preventDefault();
                    redo();
                } else if (e.key === 'Delete') {
                    e.preventDefault();
                    deleteSelected();
                } else if (e.ctrlKey && e.key === '0') {
                    e.preventDefault();
                    resetZoom();
                }
            });

            document.addEventListener('keyup', function(e) {
                if (e.key === ' ') {
                    e.spaceKey = false;
                    isPanning = false;
                }
            });
        }

        function drawPolygonPreview(points, fillColor, strokeColor) {
            canvas.getObjects().forEach(obj => {
                if (obj.objectType === 'preview') {
                    canvas.remove(obj);
                }
            });

            if (points.length >= 2) {
                const lines = [];
                for (let i = 0; i < points.length - 1; i++) {
                    lines.push(new fabric.Line([points[i].x, points[i].y, points[i + 1].x, points[i + 1].y], {
                        stroke: strokeColor,
                        strokeWidth: 2,
                        selectable: false,
                        objectType: 'preview'
                    }));
                }

                lines.forEach(line => canvas.add(line));

                points.forEach(point => {
                    const circle = new fabric.Circle({
                        left: point.x,
                        top: point.y,
                        radius: 5,
                        fill: strokeColor,
                        originX: 'center',
                        originY: 'center',
                        selectable: false,
                        objectType: 'preview'
                    });
                    canvas.add(circle);
                });
            }

            canvas.renderAll();
        }

        // Initialize Lucide icons
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>
