<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Designer - Quote #{{ quote.quote_number }}</title>

    <!-- Fabric.js for interactive canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f6fa;
            color: #2c3e50;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #00358A 0%, #002060 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header-info {
            text-align: right;
            font-size: 14px;
            opacity: 0.9;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        /* Wizard Steps */
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .wizard-step {
            flex: 1;
            text-align: center;
            padding: 10px;
            position: relative;
        }

        .wizard-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background: #ddd;
            z-index: -1;
        }

        .wizard-step.active {
            color: #00358A;
            font-weight: 600;
        }

        .wizard-step.active .step-number {
            background: #00358A;
            color: white;
        }

        .wizard-step.completed .step-number {
            background: #27ae60;
            color: white;
        }

        .step-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            line-height: 40px;
            border-radius: 50%;
            background: #ddd;
            color: #666;
            font-weight: bold;
            margin-bottom: 8px;
        }

        /* Step Containers */
        .step-container {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .step-container.active {
            display: block;
        }

        /* Upload Section */
        .upload-zone {
            border: 3px dashed #00358A;
            border-radius: 8px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-zone:hover {
            background: #f8f9ff;
            border-color: #002060;
        }

        .upload-zone.dragging {
            background: #e6eeff;
            border-color: #00358A;
        }

        .upload-icon {
            font-size: 60px;
            color: #00358A;
            margin-bottom: 20px;
        }

        /* Canvas Section */
        .canvas-wrapper {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .canvas-container {
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #f9f9f9;
            position: relative;
        }

        #roofCanvas {
            display: block;
            max-width: 100%;
        }

        .tools-panel {
            width: 300px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
        }

        .tool-section {
            margin-bottom: 25px;
        }

        .tool-section h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #00358A;
        }

        .tool-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: #f0f0f0;
            border-color: #00358A;
        }

        .tool-btn.active {
            background: #00358A;
            color: white;
            border-color: #00358A;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #00358A;
        }

        /* Results Panel */
        .results-panel {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .result-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 6px;
        }

        .result-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .result-value {
            font-size: 24px;
            font-weight: bold;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #00358A;
            color: white;
        }

        .btn-primary:hover {
            background: #002060;
        }

        .btn-secondary {
            background: #7f8c8d;
            color: white;
        }

        .btn-secondary:hover {
            background: #6c7a7b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #00358A;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
        }

        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* Confidence Badge */
        .confidence-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .confidence-high {
            background: #d4edda;
            color: #155724;
        }

        .confidence-medium {
            background: #fff3cd;
            color: #856404;
        }

        .confidence-low {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingText" style="margin-top: 20px; font-weight: 600;">Processing...</p>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div>
                <h1>üè† Roof Designer</h1>
                <p style="margin-top: 5px; opacity: 0.9;">AI-Powered Solar Panel Layout Calculator</p>
            </div>
            <div class="header-info">
                <div>Welcome, {{ user.name }}!</div>
                <div><a href="/dashboard" style="color: #D9FF0D; text-decoration: none;">‚Üê Back to Dashboard</a></div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Wizard Steps -->
        <div class="wizard-steps">
            <div class="wizard-step active" data-step="1">
                <div class="step-number">1</div>
                <div>Upload Image</div>
            </div>
            <div class="wizard-step" data-step="2">
                <div class="step-number">2</div>
                <div>Review & Edit</div>
            </div>
            <div class="wizard-step" data-step="3">
                <div class="step-number">3</div>
                <div>Calculate Layout</div>
            </div>
            <div class="wizard-step" data-step="4">
                <div class="step-number">4</div>
                <div>Finalize</div>
            </div>
        </div>

        <!-- Step 1: Upload Image -->
        <div id="step1" class="step-container active">
            <h2 style="margin-bottom: 20px;">Upload Roof Image & Customer Info</h2>
            <p style="margin-bottom: 20px; color: #666;">
                Upload a clear, top-down image of the roof. Best results with drone photos or satellite imagery from Google Maps.
            </p>

            <!-- Customer Info (Optional) -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px; font-size: 16px;">Customer Information (Optional)</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>Customer Name:</label>
                        <input type="text" id="customerName" placeholder="Enter customer name">
                    </div>
                    <div class="form-group">
                        <label>Address:</label>
                        <input type="text" id="customerAddress" placeholder="Enter roof location">
                    </div>
                </div>
            </div>

            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üì∑</div>
                <h3>Click to upload or drag & drop</h3>
                <p style="color: #666; margin-top: 10px;">JPG, PNG, or JPEG (Max 10MB)</p>
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
            </div>

            <div id="uploadedImagePreview" style="display: none; margin-top: 20px;">
                <h3>Preview:</h3>
                <img id="previewImage" style="max-width: 100%; max-height: 400px; border-radius: 8px; margin-top: 10px;">
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="analyzeImage()">Analyze Roof with AI</button>
                    <button class="btn btn-secondary" onclick="resetUpload()">Choose Different Image</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Review & Edit Detection -->
        <div id="step2" class="step-container">
            <h2 style="margin-bottom: 20px;">Review AI Detection
                <span id="confidenceBadge" class="confidence-badge"></span>
            </h2>
            <p style="margin-bottom: 20px; color: #666;">
                Review the detected roof area and obstacles. You can edit the polygon points or add/remove obstacles manually.
            </p>

            <div class="canvas-wrapper">
                <div class="canvas-container">
                    <canvas id="roofCanvas" width="800" height="600"></canvas>
                </div>

                <div class="tools-panel">
                    <div class="tool-section">
                        <h3>Edit Tools</h3>
                        <button class="tool-btn" onclick="addObstacle()">‚ûï Add Obstacle</button>
                        <button class="tool-btn" onclick="deleteSelected()">üóëÔ∏è Delete Selected</button>
                        <button class="tool-btn" onclick="resetDetection()">üîÑ Reset to AI Detection</button>
                    </div>

                    <div class="tool-section">
                        <h3>Scale Calibration</h3>
                        <div class="form-group">
                            <label>Pixels per Meter:</label>
                            <input type="number" id="pixelsPerMeter" value="100" min="10" max="500" step="10">
                            <small style="color: #666; display: block; margin-top: 5px;">
                                Adjust based on image scale
                            </small>
                        </div>
                    </div>

                    <div class="btn-group" style="flex-direction: column;">
                        <button class="btn btn-primary" onclick="proceedToLayout()">Continue to Layout</button>
                        <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Panel Layout Configuration -->
        <div id="step3" class="step-container">
            <h2 style="margin-bottom: 20px;">Configure Solar Panel Layout</h2>

            <div class="canvas-wrapper">
                <div class="canvas-container">
                    <canvas id="layoutCanvas" width="800" height="600"></canvas>
                </div>

                <div class="tools-panel">
                    <div class="tool-section">
                        <h3>Panel Specifications</h3>

                        <div class="form-group">
                            <label>Panel Size:</label>
                            <select id="panelSize" onchange="updatePanelDimensions()">
                                <option value="1.7,1.0,400">1.7m √ó 1.0m (400W)</option>
                                <option value="2.0,1.0,500">2.0m √ó 1.0m (500W)</option>
                                <option value="1.6,1.0,350">1.6m √ó 1.0m (350W)</option>
                                <option value="custom">Custom Size</option>
                            </select>
                        </div>

                        <div id="customPanelInputs" style="display: none;">
                            <div class="form-group">
                                <label>Width (m):</label>
                                <input type="number" id="panelWidth" value="1.7" step="0.1" min="0.5" max="3">
                            </div>
                            <div class="form-group">
                                <label>Height (m):</label>
                                <input type="number" id="panelHeight" value="1.0" step="0.1" min="0.5" max="3">
                            </div>
                            <div class="form-group">
                                <label>Power (W):</label>
                                <input type="number" id="panelPower" value="400" step="50" min="100" max="1000">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Orientation:</label>
                            <select id="orientation">
                                <option value="landscape">Landscape</option>
                                <option value="portrait">Portrait</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Spacing (cm):</label>
                            <input type="number" id="spacing" value="5" min="0" max="20" step="1">
                        </div>

                        <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="calculatePanelLayout()">
                            ‚ö° Calculate Layout
                        </button>
                    </div>

                    <div id="layoutResults" style="display: none;">
                        <div class="results-panel">
                            <h3 style="margin-bottom: 10px;">Layout Results</h3>
                            <div class="results-grid">
                                <div class="result-item">
                                    <div class="result-label">Total Panels</div>
                                    <div class="result-value" id="resultPanels">0</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">System Power</div>
                                    <div class="result-value" id="resultPower">0 kW</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">Roof Coverage</div>
                                    <div class="result-value" id="resultCoverage">0%</div>
                                </div>
                                <div class="result-item">
                                    <div class="result-label">Roof Area</div>
                                    <div class="result-value" id="resultArea">0 m¬≤</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="btn-group" style="flex-direction: column;">
                        <button class="btn btn-success" onclick="saveDesign()" id="saveBtn" disabled>üíæ Save Design</button>
                        <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back to Edit</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 4: Finalize -->
        <div id="step4" class="step-container">
            <div class="alert alert-success">
                <h3>‚úÖ Roof Design Completed!</h3>
                <p style="margin-top: 10px;">Your roof panel layout has been saved successfully.</p>
            </div>

            <div class="results-panel">
                <h3>Final Design Summary</h3>
                <div class="results-grid">
                    <div class="result-item">
                        <div class="result-label">Total Panels</div>
                        <div class="result-value" id="finalPanels">0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">System Power</div>
                        <div class="result-value" id="finalPower">0 kW</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Roof Coverage</div>
                        <div class="result-value" id="finalCoverage">0%</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Roof Area</div>
                        <div class="result-value" id="finalArea">0 m¬≤</div>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="window.location.href='/dashboard'">‚Üê Back to Dashboard</button>
                <button class="btn btn-success" onclick="startNewDesign()">Create New Design</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 1;
        let designId = null;
        let roofPolygon = null;
        let obstacles = [];
        let panels = [];
        let canvas = null;
        let layoutCanvas = null;
        let uploadedImage = null;
        let originalDetection = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setupUploadZone();
        });

        // Setup upload zone
        function setupUploadZone() {
            const uploadZone = document.getElementById('uploadZone');
            const imageInput = document.getElementById('imageInput');

            uploadZone.addEventListener('click', () => imageInput.click());

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragging');
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.classList.remove('dragging');
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragging');
                handleFileSelect(e.dataTransfer.files[0]);
            });

            imageInput.addEventListener('change', (e) => {
                handleFileSelect(e.target.files[0]);
            });
        }

        // Handle file selection
        function handleFileSelect(file) {
            if (!file || !file.type.startsWith('image/')) {
                alert('Please select a valid image file');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('File too large. Maximum size is 10MB');
                return;
            }

            uploadedImage = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('uploadZone').style.display = 'none';
                document.getElementById('uploadedImagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        // Reset upload
        function resetUpload() {
            uploadedImage = null;
            document.getElementById('uploadZone').style.display = 'block';
            document.getElementById('uploadedImagePreview').style.display = 'none';
            document.getElementById('imageInput').value = '';
        }

        // Analyze image with AI
        async function analyzeImage() {
            if (!uploadedImage) return;

            showLoading('Analyzing roof with AI...');

            const formData = new FormData();
            formData.append('file', uploadedImage);

            // Add optional customer info
            const customerName = document.getElementById('customerName').value;
            const customerAddress = document.getElementById('customerAddress').value;
            if (customerName) formData.append('customer_name', customerName);
            if (customerAddress) formData.append('customer_address', customerAddress);

            try {
                const response = await fetch('/api/roof-designer/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    designId = result.design_id;
                    roofPolygon = result.roof_polygon;
                    obstacles = result.obstacles;
                    originalDetection = { roofPolygon: [...roofPolygon], obstacles: [...obstacles] };

                    // Update confidence badge
                    const badge = document.getElementById('confidenceBadge');
                    const confidence = result.confidence;
                    badge.textContent = `Confidence: ${(confidence * 100).toFixed(0)}%`;

                    if (confidence > 0.7) {
                        badge.className = 'confidence-badge confidence-high';
                    } else if (confidence > 0.5) {
                        badge.className = 'confidence-badge confidence-medium';
                    } else {
                        badge.className = 'confidence-badge confidence-low';
                    }

                    // Initialize canvas
                    initializeCanvas(result.image_url);
                    goToStep(2);
                } else {
                    alert('Error: ' + (result.error || 'Failed to analyze image'));
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                alert('Failed to analyze image. Please try again.');
            }
        }

        // Initialize Fabric.js canvas
        function initializeCanvas(imageUrl) {
            canvas = new fabric.Canvas('roofCanvas', {
                selection: true
            });

            // Load background image
            fabric.Image.fromURL(imageUrl, (img) => {
                const scale = Math.min(800 / img.width, 600 / img.height);
                img.scale(scale);
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                canvas.setDimensions({ width: img.width * scale, height: img.height * scale });

                // Draw detected roof polygon
                drawRoofPolygon();
                drawObstacles();
            });
        }

        // Draw roof polygon
        function drawRoofPolygon() {
            if (!roofPolygon || !canvas) return;

            const points = roofPolygon.map(p => ({ x: p[0] || p.x, y: p[1] || p.y }));

            const polygon = new fabric.Polygon(points, {
                fill: 'rgba(0, 123, 255, 0.2)',
                stroke: '#007bff',
                strokeWidth: 3,
                selectable: true,
                hasControls: true,
                hasBorders: true,
                objectCaching: false
            });

            canvas.add(polygon);
            canvas.roofPolygon = polygon;
            canvas.renderAll();
        }

        // Draw obstacles
        function drawObstacles() {
            if (!obstacles || !canvas) return;

            obstacles.forEach((obs, index) => {
                const rect = new fabric.Rect({
                    left: obs.x,
                    top: obs.y,
                    width: obs.width,
                    height: obs.height,
                    fill: 'rgba(255, 0, 0, 0.3)',
                    stroke: '#dc3545',
                    strokeWidth: 2,
                    selectable: true,
                    hasControls: true,
                    hasBorders: true
                });

                canvas.add(rect);
            });

            canvas.renderAll();
        }

        // Add obstacle manually
        function addObstacle() {
            if (!canvas) return;

            const rect = new fabric.Rect({
                left: 100,
                top: 100,
                width: 80,
                height: 80,
                fill: 'rgba(255, 0, 0, 0.3)',
                stroke: '#dc3545',
                strokeWidth: 2,
                selectable: true,
                hasControls: true
            });

            canvas.add(rect);
            canvas.setActiveObject(rect);
            canvas.renderAll();
        }

        // Delete selected object
        function deleteSelected() {
            if (!canvas) return;

            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject !== canvas.roofPolygon) {
                canvas.remove(activeObject);
                canvas.renderAll();
            } else if (activeObject === canvas.roofPolygon) {
                alert('Cannot delete roof polygon');
            }
        }

        // Reset to original AI detection
        function resetDetection() {
            if (!originalDetection || !canvas) return;

            canvas.clear();
            roofPolygon = [...originalDetection.roofPolygon];
            obstacles = [...originalDetection.obstacles];

            fabric.Image.fromURL(canvas.backgroundImage._originalElement.src, (img) => {
                const scale = Math.min(800 / img.width, 600 / img.height);
                img.scale(scale);
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));

                drawRoofPolygon();
                drawObstacles();
            });
        }

        // Proceed to layout calculation
        function proceedToLayout() {
            // Extract current roof polygon and obstacles from canvas
            if (canvas.roofPolygon) {
                roofPolygon = canvas.roofPolygon.points.map(p => [p.x, p.y]);
            }

            obstacles = [];
            canvas.getObjects().forEach(obj => {
                if (obj.type === 'rect' && obj !== canvas.roofPolygon) {
                    obstacles.push({
                        x: obj.left,
                        y: obj.top,
                        width: obj.width * obj.scaleX,
                        height: obj.height * obj.scaleY
                    });
                }
            });

            goToStep(3);
            initializeLayoutCanvas();
        }

        // Initialize layout canvas
        function initializeLayoutCanvas() {
            layoutCanvas = new fabric.Canvas('layoutCanvas', {
                selection: false
            });

            // Copy background from editing canvas
            if (canvas.backgroundImage) {
                fabric.Image.fromURL(canvas.backgroundImage._originalElement.src, (img) => {
                    const scale = Math.min(800 / img.width, 600 / img.height);
                    img.scale(scale);
                    layoutCanvas.setBackgroundImage(img, layoutCanvas.renderAll.bind(layoutCanvas));
                    layoutCanvas.setDimensions({ width: img.width * scale, height: img.height * scale });

                    // Redraw roof and obstacles (non-editable)
                    drawLayoutBase();
                });
            }
        }

        // Draw base layout (roof + obstacles)
        function drawLayoutBase() {
            if (!roofPolygon || !layoutCanvas) return;

            const points = roofPolygon.map(p => ({ x: p[0], y: p[1] }));
            const polygon = new fabric.Polygon(points, {
                fill: 'rgba(0, 123, 255, 0.15)',
                stroke: '#007bff',
                strokeWidth: 2,
                selectable: false
            });

            layoutCanvas.add(polygon);

            obstacles.forEach(obs => {
                const rect = new fabric.Rect({
                    left: obs.x,
                    top: obs.y,
                    width: obs.width,
                    height: obs.height,
                    fill: 'rgba(255, 0, 0, 0.2)',
                    stroke: '#dc3545',
                    strokeWidth: 2,
                    selectable: false
                });
                layoutCanvas.add(rect);
            });

            layoutCanvas.renderAll();
        }

        // Update panel dimensions from select
        function updatePanelDimensions() {
            const select = document.getElementById('panelSize');
            const customInputs = document.getElementById('customPanelInputs');

            if (select.value === 'custom') {
                customInputs.style.display = 'block';
            } else {
                customInputs.style.display = 'none';
                const [width, height, power] = select.value.split(',');
                document.getElementById('panelWidth').value = width;
                document.getElementById('panelHeight').value = height;
                document.getElementById('panelPower').value = power;
            }
        }

        // Calculate panel layout
        async function calculatePanelLayout() {
            showLoading('Calculating optimal panel layout...');

            const panelWidth = parseFloat(document.getElementById('panelWidth').value);
            const panelHeight = parseFloat(document.getElementById('panelHeight').value);
            const panelPower = parseInt(document.getElementById('panelPower').value);
            const spacing = parseFloat(document.getElementById('spacing').value) / 100; // Convert cm to m
            const orientation = document.getElementById('orientation').value;
            const pixelsPerMeter = parseFloat(document.getElementById('pixelsPerMeter').value);

            const formData = new FormData();
            formData.append('design_id', designId);
            formData.append('roof_polygon', JSON.stringify(roofPolygon));
            formData.append('obstacles', JSON.stringify(obstacles));
            formData.append('panel_width_m', panelWidth);
            formData.append('panel_height_m', panelHeight);
            formData.append('panel_power_w', panelPower);
            formData.append('spacing_m', spacing);
            formData.append('pixels_per_meter', pixelsPerMeter);
            formData.append('orientation', orientation);

            try {
                const response = await fetch('/api/roof-designer/calculate-layout', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    panels = result.panels;
                    displayPanels();
                    displayResults(result);
                    document.getElementById('saveBtn').disabled = false;
                } else {
                    alert('Error: ' + (result.error || 'Failed to calculate layout'));
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                alert('Failed to calculate layout. Please try again.');
            }
        }

        // Display panels on canvas
        function displayPanels() {
            if (!layoutCanvas || !panels) return;

            // Remove existing panels
            layoutCanvas.getObjects().forEach(obj => {
                if (obj.panelMarker) {
                    layoutCanvas.remove(obj);
                }
            });

            // Draw new panels
            panels.forEach(panel => {
                const rect = new fabric.Rect({
                    left: panel.x,
                    top: panel.y,
                    width: panel.width,
                    height: panel.height,
                    fill: 'rgba(255, 193, 7, 0.6)',
                    stroke: '#ff9800',
                    strokeWidth: 1,
                    selectable: false,
                    panelMarker: true
                });
                layoutCanvas.add(rect);
            });

            layoutCanvas.renderAll();
        }

        // Display results
        function displayResults(result) {
            document.getElementById('resultPanels').textContent = result.total_panels;
            document.getElementById('resultPower').textContent = result.total_power_kw + ' kW';
            document.getElementById('resultCoverage').textContent = result.coverage_percent + '%';
            document.getElementById('resultArea').textContent = result.roof_area_m2 + ' m¬≤';
            document.getElementById('layoutResults').style.display = 'block';
        }

        // Save design
        async function saveDesign() {
            showLoading('Saving design...');

            try {
                // Generate visualization
                const formData = new FormData();
                formData.append('design_id', designId);

                const response = await fetch('/api/roof-designer/save-visualization', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                hideLoading();

                if (result.success) {
                    // Copy results to final step
                    document.getElementById('finalPanels').textContent = document.getElementById('resultPanels').textContent;
                    document.getElementById('finalPower').textContent = document.getElementById('resultPower').textContent;
                    document.getElementById('finalCoverage').textContent = document.getElementById('resultCoverage').textContent;
                    document.getElementById('finalArea').textContent = document.getElementById('resultArea').textContent;

                    goToStep(4);
                } else {
                    alert('Error saving design');
                }
            } catch (error) {
                hideLoading();
                console.error('Error:', error);
                alert('Failed to save design. Please try again.');
            }
        }

        // Start new design
        function startNewDesign() {
            window.location.href = '/roof-designer';
        }

        // Navigation functions
        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('.step-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.wizard-step').forEach(el => {
                el.classList.remove('active');
                if (parseInt(el.dataset.step) < step) {
                    el.classList.add('completed');
                } else {
                    el.classList.remove('completed');
                }
            });

            // Show target step
            document.getElementById(`step${step}`).classList.add('active');
            document.querySelector(`[data-step="${step}"]`).classList.add('active');
            currentStep = step;

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Loading overlay
        function showLoading(text = 'Processing...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
    </script>
</body>
</html>
