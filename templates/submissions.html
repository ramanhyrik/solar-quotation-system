<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>פניות לקוחות - הצעות מחיר סולאריות</title>
    <link rel="stylesheet" href="/static/dashboard.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .submissions-table {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .submissions-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .submissions-table th {
            background: linear-gradient(135deg, #00358A 0%, #002d75 100%);
            color: white;
            padding: 15px;
            text-align: right;
            font-weight: 600;
            font-size: 14px;
        }

        .submissions-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 14px;
        }

        .submissions-table tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-new { background: #fef3c7; color: #92400e; }
        .status-contacted { background: #dbeafe; color: #1e40af; }
        .status-quoted { background: #e0e7ff; color: #4338ca; }
        .status-converted { background: #d1fae5; color: #065f46; }
        .status-rejected { background: #fee2e2; color: #991b1b; }

        .action-btn {
            padding: 6px 12px;
            margin: 0 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-view {
            background: #3b82f6;
            color: white;
        }

        .btn-view:hover {
            background: #2563eb;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-content {
            background: white;
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            border-radius: 12px;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            left: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
        }

        .detail-value {
            color: #333;
        }

        .signature-image {
            max-width: 100%;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #00358A;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            width: 64px;
            height: 64px;
            margin-bottom: 20px;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2><i data-lucide="sun" style="width: 24px; height: 24px; vertical-align: middle; margin-left: 8px;"></i> אנרגיה סולארית</h2>
        <nav>
            <a href="/dashboard">הצעה חדשה</a>
            <a href="/dashboard?section=history">היסטוריית הצעות</a>
            <a href="/admin">לוח ניהול</a>
            <a href="/submissions" class="active">פניות לקוחות</a>
            <a href="/roof-designer">מעצב גגות</a>
            <a href="/dashboard?section=calculator">מחשבון</a>
            <a href="/dashboard?section=comparison">השוואת תזרים מזומנים</a>
            <a href="/logout">התנתק</a>
        </nav>
        <div class="user-info">
            <p>{{ user.email }}</p>
            <p><small>מנהל</small></p>
        </div>
    </div>

    <div class="main-content">
        <h1>פניות לקוחות</h1>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-value" id="totalSubmissions">0</div>
                <div class="stat-label">סך הכל פניות</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="newSubmissions">0</div>
                <div class="stat-label">פניות חדשות</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="convertedSubmissions">0</div>
                <div class="stat-label">הומרו ללקוחות</div>
            </div>
        </div>

        <div class="submissions-table">
            <table id="submissionsTable">
                <thead>
                    <tr>
                        <th>תאריך</th>
                        <th>שם</th>
                        <th>טלפון</th>
                        <th>אימייל</th>
                        <th>שטח גג</th>
                        <th>סטטוס</th>
                        <th>פעולות</th>
                    </tr>
                </thead>
                <tbody id="submissionsBody">
                </tbody>
            </table>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <i data-lucide="inbox"></i>
            <h3>אין פניות עדיין</h3>
            <p>פניות לקוחות מטופס יצירת הקשר יופיעו כאן</p>
        </div>
    </div>

    <!-- Modal for viewing submission details -->
    <div id="submissionModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h2>פרטי פנייה</h2>

            <div class="detail-grid" id="submissionDetails"></div>

            <div style="margin: 20px 0;">
                <h3>חתימה דיגיטלית</h3>
                <img id="signatureImage" class="signature-image" src="" alt="חתימת לקוח">
            </div>

            <form id="updateForm" style="margin-top: 30px; border-top: 2px solid #e2e8f0; padding-top: 20px;">
                <div class="form-group">
                    <label for="statusSelect">סטטוס</label>
                    <select id="statusSelect" required>
                        <option value="new">חדש</option>
                        <option value="contacted">יצרנו קשר</option>
                        <option value="quoted">נשלחה הצעת מחיר</option>
                        <option value="converted">הומר ללקוח</option>
                        <option value="rejected">נדחה</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="notesTextarea">הערות</label>
                    <textarea id="notesTextarea" placeholder="הוסף הערות..."></textarea>
                </div>

                <button type="submit" class="btn-calculate">עדכן פנייה</button>
            </form>
        </div>
    </div>

    <script>
        let currentSubmissionId = null;
        let allSubmissions = [];

        // Load submissions
        async function loadSubmissions() {
            try {
                const response = await fetch('/api/submissions');
                if (!response.ok) {
                    throw new Error('Failed to load submissions');
                }

                allSubmissions = await response.json();
                renderSubmissions();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
                alert('שגיאה בטעינת הפניות');
            }
        }

        function renderSubmissions() {
            const tbody = document.getElementById('submissionsBody');
            const emptyState = document.getElementById('emptyState');
            const table = document.querySelector('.submissions-table');

            if (allSubmissions.length === 0) {
                table.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            table.style.display = 'block';
            emptyState.style.display = 'none';

            tbody.innerHTML = allSubmissions.map(sub => {
                const date = new Date(sub.submission_date).toLocaleDateString('he-IL');
                const statusClass = `status-${sub.status}`;
                const statusText = getStatusText(sub.status);

                return `
                    <tr>
                        <td>${date}</td>
                        <td>${sub.customer_name}</td>
                        <td>${sub.customer_phone || '-'}</td>
                        <td>${sub.customer_email || '-'}</td>
                        <td>${sub.roof_area ? sub.roof_area + ' מ"ר' : '-'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn btn-view" onclick="viewSubmission(${sub.id})">
                                <i data-lucide="eye" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                                צפה
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteSubmission(${sub.id})">
                                <i data-lucide="trash-2" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                                מחק
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            lucide.createIcons();
        }

        function updateStats() {
            const total = allSubmissions.length;
            const newCount = allSubmissions.filter(s => s.status === 'new').length;
            const converted = allSubmissions.filter(s => s.status === 'converted').length;

            document.getElementById('totalSubmissions').textContent = total;
            document.getElementById('newSubmissions').textContent = newCount;
            document.getElementById('convertedSubmissions').textContent = converted;
        }

        function getStatusText(status) {
            const statusMap = {
                'new': 'חדש',
                'contacted': 'יצרנו קשר',
                'quoted': 'נשלחה הצעה',
                'converted': 'הומר ללקוח',
                'rejected': 'נדחה'
            };
            return statusMap[status] || status;
        }

        function viewSubmission(id) {
            const submission = allSubmissions.find(s => s.id === id);
            if (!submission) return;

            currentSubmissionId = id;

            // Populate details
            const details = document.getElementById('submissionDetails');
            details.innerHTML = `
                <div class="detail-label">שם מלא:</div>
                <div class="detail-value">${submission.customer_name}</div>

                <div class="detail-label">טלפון:</div>
                <div class="detail-value">${submission.customer_phone || '-'}</div>

                <div class="detail-label">אימייל:</div>
                <div class="detail-value">${submission.customer_email || '-'}</div>

                <div class="detail-label">כתובת:</div>
                <div class="detail-value">${submission.customer_address || '-'}</div>

                <div class="detail-label">שטח גג:</div>
                <div class="detail-value">${submission.roof_area ? submission.roof_area + ' מ"ר' : '-'}</div>

                <div class="detail-label">תאריך פנייה:</div>
                <div class="detail-value">${new Date(submission.submission_date).toLocaleString('he-IL')}</div>
            `;

            // Set signature image
            document.getElementById('signatureImage').src = '/' + submission.signature_path;

            // Set form values
            document.getElementById('statusSelect').value = submission.status;
            document.getElementById('notesTextarea').value = submission.notes || '';

            // Show modal
            document.getElementById('submissionModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('submissionModal').style.display = 'none';
            currentSubmissionId = null;
        }

        // Update submission
        document.getElementById('updateForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentSubmissionId) return;

            const formData = new FormData();
            formData.append('status', document.getElementById('statusSelect').value);
            formData.append('notes', document.getElementById('notesTextarea').value);

            try {
                const response = await fetch(`/api/submissions/${currentSubmissionId}`, {
                    method: 'PUT',
                    body: formData
                });

                if (response.ok) {
                    alert('הפנייה עודכנה בהצלחה!');
                    closeModal();
                    loadSubmissions();
                } else {
                    alert('שגיאה בעדכון הפנייה');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('שגיאה בעדכון הפנייה');
            }
        });

        // Delete submission
        async function deleteSubmission(id) {
            if (!confirm('האם אתה בטוח שברצונך למחוק פנייה זו?')) {
                return;
            }

            try {
                const response = await fetch(`/api/submissions/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('הפנייה נמחקה בהצלחה');
                    loadSubmissions();
                } else {
                    alert('שגיאה במחיקת הפנייה');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('שגיאה במחיקת הפנייה');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('submissionModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize
        loadSubmissions();
        lucide.createIcons();
    </script>
</body>
</html>
